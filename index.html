<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Muebles de Melamina</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados si son necesarios */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: #333;
        }
        .container.mx-auto {
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            /* Ajuste para limitar el ancho máximo del contenedor principal */
            max-width: 1000px; /* Puedes ajustar este valor según prefieras */
        }
        h1, h2, h3 {
            color: #333;
        }
        .form-section, .mueble-item, .materials-list-section .mueble-materials, .saved-quotes-list-section li {
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }
        .form-group label {
            font-weight: bold;
        }
        input[type="text"], input[type="number"], select {
            border: 1px solid #ccc;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-delete:hover {
            background-color: #c82333;
        }
         /* Hide custom material inputs by default */
         .custom-material-inputs {
             display: none;
             /* Ajuste en la plantilla de cuadrícula para priorizar el nombre */
             /* Nombre (2fr) tendrá el doble de espacio que Precio (1fr) y Cantidad (1fr) */
             grid-template-columns: 2fr 1fr 1fr;
             gap: 10px;
             margin-top: 10px;
             padding: 10px;
             border: 1px dashed #ccc;
             width: 100%; /* Ensure it takes full width of its container */
             box-sizing: border-box; /* Include padding and border in element's total width */
         }
         .custom-material-inputs label {
             font-weight: normal;
             font-size: 0.9em;
             margin-bottom: 3px;
         }
         .custom-material-inputs input {
             padding: 5px;
             font-size: 0.9rem;
             text-align: center;
             width: 100%; /* Ensure inputs within the grid take full cell width */
             box-sizing: border-box; /* Include padding and border in input's total width */
         }

         /* Adjust parent flex item to wrap if necessary */
         .herraje-item {
             display: flex;
             flex-wrap: wrap; /* Allow items to wrap to the next line */
             align-items: center;
             gap: 10px; /* Adjusted gap for consistency */
             margin-bottom: 15px; /* Adjusted margin */
         }

         .herraje-item select,
         .herraje-item input[type="number"] {
             /* Allow select and number input to shrink */
             flex-shrink: 1;
         }

         .herraje-item .btn-delete {
             /* Prevent delete button from shrinking too much */
             flex-shrink: 0;
         }


          /* Custom styles for the price update modal */
         .dialogo-precios {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0,0,0,0.5);
             display: flex;
             justify-content: center;
             align-items: center;
             z-index: 1000;
         }
         .dialogo-contenido {
             background-color: #fff;
             padding: 20px;
             border-radius: 8px;
             max-width: 600px;
             max-height: 80vh;
             overflow-y: auto;
             box-shadow: 0 4px 8px rgba(0,0,0,0.2);
         }
          .dialogo-contenido h2 {
              margin-top: 0;
              border-bottom: 1px solid #eee;
              padding-bottom: 10px;
              margin-bottom: 20px;
          }
          .dialogo-contenido h3 {
              margin-top: 15px;
              margin-bottom: 10px;
          }
         .precio-item {
             display: grid;
             grid-template-columns: 2fr 1fr;
             gap: 10px;
             margin-bottom: 8px;
             align-items: center;
         }
          .precio-item label {
              margin-bottom: 0;
          }
          .dialogo-contenido button {
              margin-top: 15px;
          }

          /* Styles for the production materials list section */
          .materials-list-section {
              margin-top: 20px;
              padding-top: 20px;
              border-top: 1px solid #ddd;
          }
          .materials-list-section h2 {
              margin-bottom: 15px;
          }
          .materials-list-section ul {
              list-style: none;
              padding: 0;
          }
          .materials-list-section li {
              background-color: #eee;
              border: 1px solid #ccc;
              padding: 8px;
              margin-bottom: 5px;
              border-radius: 4px;
          }
          .materials-list-section li strong {
              color: #555;
          }
          .materials-list-section .mueble-materials {
              border: 1px solid #ccc;
              padding: 15px;
              margin-bottom: 20px;
              border-radius: 8px;
              background-color: #fff;
          }
          .materials-list-section .mueble-materials h3 {
              margin-top: 0;
              margin-bottom: 10px;
              border-bottom: 1px dashed #ccc;
              padding-bottom: 5px;
          }
          .materials-list-section .mueble-materials ul {
              padding-left: 20px;
          }
          .materials-list-section .mueble-materials li {
              background-color: transparent;
              border: none;
              padding: 2px 0;
              margin-bottom: 2px;
          }

         /* Styles for saved quotes list */
         .saved-quotes-list-section {
             margin-top: 20px;
             padding-top: 20px;
             border-top: 1px solid #ddd;
         }
         .saved-quotes-list-section h2 {
             margin-bottom: 15px;
         }
         .saved-quotes-list-section ul {
             list-style: none;
             padding: 0;
         }
         .saved-quotes-list-section li {
             background-color: #e9ecef;
             border: 1px solid #ced4da;
             padding: 10px;
             margin-bottom: 8px;
             border-radius: 5px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 10px;
         }
         .saved-quotes-list-section li .quote-info {
             flex-grow: 1;
         }
         .saved-quotes-list-section li .quote-actions button {
             padding: 5px 10px;
             font-size: 0.9rem;
             margin-left: 5px;
             border-radius: 5px;
         }


    </style>
    <script>
        // ======================================================================
        // Variables Globales y Base de Datos de Materiales (IndexedDB)
        // ======================================================================

        // Base de datos de materiales con sus precios (se inicializará con IndexedDB si hay datos guardados)
        let materiales = {
            tableros: {
                "melamina_blanca_18mm": { nombre: "Melamina Blanca 18mm", precio: 60.00 },
                "melamina_blanca_15mm": { nombre: "Melamina Blanca 15mm", precio: 55.00 },
                "melamina_blanca_6mm": { nombre: "Melamina Blanca 6mm", precio: 40.00 }
            },
             // Sección para cantos
            cantos: {
                 "canto_blanco_22mm": { nombre: "Canto blanco 22mm", precio: 10.00 },
            },
            herrajes: {
                correderas: {
                    "tandem_300mm": { nombre: "Tandem 300mm", precio: 600 },
                    "tandem_350mm": { nombre: "Tandem 350mm", precio: 650 },
                    "tandem_400mm": { nombre: "Tandem 400mm", precio: 700 },
                    "tandem_450mm": { nombre: "Tandem 450mm", precio: 750 },
                    "tandem_500mm": { nombre: "Tandem 500mm", precio: 800 },
                    "metabox_400mm": { nombre: "Metabox 400mm", precio: 750 },
                    "metabox_450mm": { nombre: "Metabox 450mm", precio: 850 },
                    "metabox_500mm": { nombre: "Metabox 500mm", precio: 1000 }
                },
                bisagras: {
                    "montaje_interior": { nombre: "Montaje Interior", precio: 300 },
                    "montaje_exterior": { nombre: "Montaje Exterior", precio: 350 }
                },
                tiradores: {
                    "tirador_90mm": { nombre: "Tirador 90mm", precio: 60 },
                    "tirador_120mm": { nombre: "Tirador 120mm", precio: 80 },
                    "clicatto": { nombre: "Clicatto", precio: 1300 },
                    "gola": { nombre: "Gola", precio: 1500 }
                },
                // Todos los herrajes que no son correderas, bisagras o tiradores se agrupan aquí
                otros: {
                    "enganche_aereo": { nombre: "Enganche Aéreo", precio: 90 },
                    "enganche_base": { nombre: "Enganche Base", precio: 150 },
                    "zocalo": { nombre: "Zócalo", precio: 1200 },
                    "barra_closet": { nombre: "Barra de Closet", precio: 1500 },
                    "patas": { nombre: "Patas", precio: 45 },
                    "esquineros": { nombre: "Esquineros", precio: 50 },
                    "gancho_patas": { nombre: "Gancho Patas", precio: 25 }
                }
            }
        };

        // Información de la empresa (predefinida)
        const infoEmpresa = {
            nombre: "VARGAS ARQUITECTOS",
            direccion: "Calle 9, no.22 Villa Carmen, Santo Domingo Este.",
            telefono: "(829) 613-8006",
            email: "arq.jesusvargas01@gmail.com",
            logoUrl: "https://i.postimg.cc/y6wLjccb/Captura-de-pantalla-2025-04-24-133337.png" // URL del logo proporcionada
        };


        // Array para almacenar los muebles agregados (cotización actual)
        let muebles = [];

        // Array para almacenar las cotizaciones guardadas (se cargará desde IndexedDB)
        let cotizacionesGuardadas = [];

        // Variable para la base de datos IndexedDB
        let db;
        const dbName = 'CotizadorDB';
        const dbVersion = 1; // Incrementar si cambias la estructura de los almacenes

        // Nombres de los Object Stores
        const preciosStoreName = 'preciosMateriales';
        const cotizacionesStoreName = 'cotizacionesGuardadas';


        // ======================================================================
        // Funciones de IndexedDB
        // ======================================================================

        // Función para abrir o crear la base de datos IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                console.log('IndexedDB: Intentando abrir o crear base de datos...'); // Debug log
                const request = indexedDB.open(dbName, dbVersion);

                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    console.log('IndexedDB: Actualizando o creando base de datos...');

                    // Crear object store para precios de materiales si no existe
                    if (!db.objectStoreNames.contains(preciosStoreName)) {
                        const preciosStore = db.createObjectStore(preciosStoreName, { keyPath: 'id' });
                        console.log(`IndexedDB: Object store "${preciosStoreName}" creado.`); // Debug log
                         // No necesitamos índices para precios ya que solo guardamos un objeto grande
                    }

                    // Crear object store para cotizaciones guardadas si no existe
                    if (!db.objectStoreNames.contains(cotizacionesStoreName)) {
                        const cotizacionesStore = db.createObjectStore(cotizacionesStoreName, { keyPath: 'id' });
                        console.log(`IndexedDB: Object store "${cotizacionesStoreName}" creado.`); // Debug log
                        // Crear un índice para buscar cotizaciones por nombre de cliente
                        cotizacionesStore.createIndex('nombreCliente', 'nombreCliente', { unique: false });
                        console.log(`IndexedDB: Índice "nombreCliente" creado en "${cotizacionesStoreName}".`); // Debug log
                    }
                };

                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log('IndexedDB: Base de datos abierta con éxito.');
                    resolve(db);
                };

                request.onerror = function(event) {
                    console.error('IndexedDB: Error al abrir la base de datos:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Función para obtener datos de un object store
        function getDataFromStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error(`IndexedDB: DB no inicializada al intentar obtener datos de ${storeName}.`); // Debug log
                    reject('IndexedDB no inicializada.');
                    return;
                }
                const transaction = db.transaction([storeName], 'readonly');
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.getAll(); // Obtener todos los objetos

                request.onsuccess = function(event) {
                    console.log(`IndexedDB: Datos obtenidos de ${storeName}.`, event.target.result); // Debug log
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    console.error(`IndexedDB: Error al obtener datos de ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

         // Función para obtener un objeto específico por su keyPath (id)
         function getObjectFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error(`IndexedDB: DB no inicializada al intentar obtener objeto con ID ${id} de ${storeName}.`); // Debug log
                    reject('IndexedDB no inicializada.');
                    return;
                }
                const transaction = db.transaction([storeName], 'readonly');
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.get(id); // Obtener el objeto por ID

                request.onsuccess = function(event) {
                    console.log(`IndexedDB: Objeto con ID ${id} obtenido de ${storeName}.`, event.target.result); // Debug log
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    console.error(`IndexedDB: Error al obtener objeto con ID ${id} de ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
         }


        // Función para añadir o actualizar datos en un object store
        function putDataInStore(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                     console.error(`IndexedDB: DB no inicializada al intentar guardar datos en ${storeName}.`); // Debug log
                    reject('IndexedDB no inicializada.');
                    return;
                }
                const transaction = db.transaction([storeName], 'readwrite');
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.put(data); // Añadir o actualizar (si el id ya existe)

                request.onsuccess = function(event) {
                    console.log(`IndexedDB: Datos guardados en ${storeName}.`, data); // Debug log
                    resolve(event.target.result); // Retorna la keyPath del objeto añadido/actualizado
                };

                request.onerror = function(event) {
                    console.error(`IndexedDB: Error al guardar datos en ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Función para eliminar un objeto de un object store por su keyPath (id)
        function deleteDataFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error(`IndexedDB: DB no inicializada al intentar eliminar objeto con ID ${id} de ${storeName}.`); // Debug log
                    reject('IndexedDB no inicializada.');
                    return;
                }
                const transaction = db.transaction([storeName], 'readwrite');
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.delete(id); // Eliminar por ID

                request.onsuccess = function(event) {
                    console.log(`IndexedDB: Objeto con ID ${id} eliminado de ${storeName}.`);
                    resolve();
                };

                request.onerror = function(event) {
                    console.error(`IndexedDB: Error al eliminar objeto con ID ${id} de ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

         // Función para limpiar un object store
         function clearStore(storeName) {
             return new Promise((resolve, reject) => {
                 if (!db) {
                     console.error(`IndexedDB: DB no inicializada al intentar limpiar ${storeName}.`); // Debug log
                    reject('IndexedDB no inicializada.');
                    return;
                 }
                 const transaction = db.transaction([storeName], 'readwrite');
                 const objectStore = transaction.objectStore(storeName);
                 const request = objectStore.clear(); // Eliminar todos los objetos

                 request.onsuccess = function(event) {
                     console.log(`IndexedDB: Object store "${storeName}" limpiado.`);
                     resolve();
                 };

                 request.onerror = function(event) {
                     console.error(`IndexedDB: Error al limpiar object store "${storeName}":`, event.target.error);
                     reject(event.target.error);
                 };
             });
         }


        // ======================================================================
        // Funciones de Cálculo
        // ======================================================================

        // Función para calcular el costo base de un mueble (solo materiales)
        function calcularCostoBaseMueble(mueble) {
            let costoMateriales = 0;

            // Sumar costo de tableros
            for (const tablero of mueble.tableros) {
                 // Verificar si es un tablero predefinido o personalizado
                 if (tablero.tipo && materiales.tableros[tablero.tipo]) {
                     costoMateriales += tablero.cantidad * materiales.tableros[tablero.tipo].precio;
                 } else if (tablero.nombre && tablero.precio !== undefined) { // Material personalizado (verificar precio no sea undefined)
                     costoMateriales += tablero.cantidad * tablero.precio;
                 } else {
                     console.warn(`Tablero con datos incompletos o desconocido:`, tablero);
                 }
            }

            // Sumar costo de cantos
            for (const canto of mueble.cantos) {
                 // Verificar si es un canto predefinido o personalizado
                 if (canto.tipo && materiales.cantos[canto.tipo]) {
                     costoMateriales += canto.cantidad * materiales.cantos[canto.tipo].precio;
                 } else if (canto.nombre && canto.precio !== undefined) { // Material personalizado
                      costoMateriales += canto.cantidad * canto.precio;
                 } else {
                     console.warn(`Canto con datos incompletos o desconocido:`, canto);
                 }
            }


            // Sumar costo de herrajes
            for (const herraje of mueble.herrajes) {
                const categoria = herraje.categoria;
                // Verificar si es un herraje predefinido o personalizado
                if (herraje.tipo && materiales.herrajes[categoria] && materiales.herrajes[categoria][herraje.tipo]) {
                    costoMateriales += herraje.cantidad * materiales.herrajes[categoria][herraje.tipo].precio;
                } else if (herraje.nombre && herraje.precio !== undefined) { // Material personalizado
                     costoMateriales += herraje.cantidad * herraje.precio;
                } else {
                     console.warn(`Herraje con datos incompletos o desconocido:`, herraje);
                }
            }

            return costoMateriales; // Retorna solo el costo de materiales
        }


        // Función para calcular el costo unitario de un mueble (con ganancia, sin cantidad total)
        function calcularCostoUnitarioMueble(mueble, porcentajeGanancia) {
            // El costo base aquí es solo materiales
            const costoBaseMateriales = calcularCostoBaseMueble(mueble);
            // Sumar costos adicionales por mueble ANTES de aplicar la ganancia, si la ganancia se aplica sobre el total
            const costoConAdicionales = costoBaseMateriales + (mueble.transporte || 0) + (mueble.instalacion || 0);
            return costoConAdicionales * (1 + porcentajeGanancia / 100);
        }

        // Función para calcular el importe total de un mueble (unitario * cantidad)
        function calcularImporteMueble(mueble, porcentajeGanancia) {
            const costoUnitario = calcularCostoUnitarioMueble(mueble, porcentajeGanancia);
            return costoUnitario * mueble.cantidad;
        }

        // Función para consolidar la lista total de materiales de todos los muebles
        function consolidarMateriales(mueblesArray) {
            const materialesConsolidados = {
                tableros: {},
                cantos: {},
                herrajes: {} // Herrajes agrupados por categoría y luego por tipo/nombre
            };

            mueblesArray.forEach(mueble => {
                // Consolidar tableros
                mueble.tableros.forEach(tablero => {
                    const key = tablero.tipo || `custom_${tablero.nombre}`; // Usar tipo o un prefijo para personalizados
                    const nombre = tablero.tipo && materiales.tableros[tablero.tipo] ? materiales.tableros[tablero.tipo].nombre : tablero.nombre;
                    const precio = tablero.tipo && materiales.tableros[tablero.tipo] ? materiales.tableros[tablero.tipo].precio : tablero.precio;

                    if (!materialesConsolidados.tableros[key]) {
                        materialesConsolidados.tableros[key] = { nombre: nombre, precio: precio, cantidad: 0 };
                    }
                    materialesConsolidados.tableros[key].cantidad += tablero.cantidad * mueble.cantidad; // Multiplicar por cantidad de muebles
                });

                // Consolidar cantos
                mueble.cantos.forEach(canto => {
                     const key = canto.tipo || `custom_${canto.nombre}`;
                     const nombre = canto.tipo && materiales.cantos[canto.tipo] ? materiales.cantos[canto.tipo].nombre : canto.nombre;
                     const precio = canto.tipo && materiales.cantos[canto.tipo] ? materiales.cantos[canto.tipo].precio : canto.precio;

                     if (!materialesConsolidados.cantos[key]) {
                         materialesConsolidados.cantos[key] = { nombre: nombre, precio: precio, cantidad: 0 };
                     }
                     materialesConsolidados.cantos[key].cantidad += canto.cantidad * mueble.cantidad; // Multiplicar por cantidad de muebles
                });

                // Consolidar herrajes
                mueble.herrajes.forEach(herraje => {
                    const categoria = herraje.categoria || 'otros'; // Usar 'otros' para personalizados sin categoría
                    const key = herraje.tipo || `custom_${herraje.nombre}`;
                    const nombre = herraje.tipo && materiales.herrajes[categoria] && materiales.herrajes[categoria][herraje.tipo] ? materiales.herrajes[categoria][herraje.tipo].nombre : herraje.nombre;
                    const precio = herraje.tipo && materiales.herrajes[categoria] && materiales.herrajes[categoria][herraje.tipo] ? materiales.herrajes[categoria][herraje.tipo].precio : herraje.precio;


                    if (!materialesConsolidados.herrajes[categoria]) {
                        materialesConsolidados.herrajes[categoria] = {};
                    }
                    if (!materialesConsolidados.herrajes[categoria][key]) {
                         materialesConsolidados.herrajes[categoria][key] = { nombre: nombre, precio: precio, cantidad: 0 };
                    }
                    materialesConsolidados.herrajes[categoria][key].cantidad += herraje.cantidad * mueble.cantidad; // Multiplicar por cantidad de muebles
                });
            });

            return materialesConsolidados;
        }


        // ======================================================================
        // Funciones de Interfaz de Usuario (UI)
        // ======================================================================

        // Función para agregar un selector y input de cantidad para un tablero (dentro de la sección de mueble actual)
        function agregarTableroItem() {
            const container = document.getElementById('current-mueble-tableros-container'); // Usar el nuevo ID
            if (!container) {
                console.error(`Contenedor para tableros del mueble actual no encontrado.`);
                return;
            }

            const div = document.createElement('div');
            div.className = 'herraje-item flex items-center gap-2 mb-3'; // Reutilizar clase de estilo y layout

            let selectHtml = `<select onchange="toggleCustomMaterialInputs(this, 'tablero')" class="flex-grow p-2 border border-gray-300 rounded-md">`;
            selectHtml += `<option value="">-- Seleccionar Tablero --</option>`; // Opción por defecto
            // Iterar sobre los tableros disponibles
            for (const [id, item] of Object.entries(materiales.tableros)) {
                selectHtml += `<option value="${id}">${item.nombre} ($${materiales.tableros[id].precio.toFixed(2)})</option>`;
            }
            selectHtml += `<option value="custom">Otro (Valor Personalizado)</option>`; // Opción para valor personalizado
            selectHtml += '</select>';

            div.innerHTML = `
                ${selectHtml}
                <input type="number" min="0" step="1" value="0" placeholder="Cantidad" class="w-24 p-2 border border-gray-300 rounded-md text-center">
                <button class="btn-delete bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded" onclick="this.parentElement.remove()">×</button>
                <div class="custom-material-inputs">
                    <input type="text" class="custom-nombre p-2 border border-gray-300 rounded-md" placeholder="Nombre">
                    <input type="number" class="custom-precio p-2 border border-gray-300 rounded-md" min="0" step="0.01" value="0" placeholder="Precio Unitario">
                    <input type="number" class="custom-cantidad p-2 border border-gray-300 rounded-md" min="0" step="1" value="0" placeholder="Cantidad">
                </div>
            `;
            container.appendChild(div);
        }


         // Función para agregar un selector y input de cantidad para un canto (dentro de la sección de mueble actual)
         function agregarCantoItem() {
             const container = document.getElementById('current-mueble-cantos-container'); // Usar el nuevo ID
             if (!container) {
                 console.error(`Contenedor para cantos del mueble actual no encontrado.`);
                 return;
             }

             const div = document.createElement('div');
             div.className = 'herraje-item flex items-center gap-2 mb-3'; // Usar flexbox y gap
             div.innerHTML = `
                 <select onchange="toggleCustomMaterialInputs(this, 'canto')" class="flex-grow p-2 border border-gray-300 rounded-md">
                     <option value="">-- Seleccionar Canto --</option>
                     ${Object.entries(materiales.cantos).map(([id, item]) =>
                         `<option value="${id}">${item.nombre} ($${materiales.cantos[id].precio.toFixed(2)})</option>`
                     ).join('')}
                     <option value="custom">Otro (Valor Personalizado)</option>
                 </select>
                 <input type="number" min="0" step="0.1" value="0" placeholder="Metros Lineales" class="w-24 p-2 border border-gray-300 rounded-md text-center">
                 <button class="btn-delete bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded" onclick="this.parentElement.remove()">×</button>
                 <div class="custom-material-inputs">
                     <input type="text" class="custom-nombre p-2 border border-gray-300 rounded-md" placeholder="Nombre">
                     <input type="number" class="custom-precio p-2 border border-gray-300 rounded-md" min="0" step="0.01" value="0" placeholder="Precio Unitario">
                     <input type="number" class="custom-cantidad p-2 border border-gray-300 rounded-md" min="0" step="0.1" value="0" placeholder="Cantidad">
                 </div>
             `;
             container.appendChild(div);
         }


        // Función para agregar un selector y input de cantidad para un herraje en una categoría específica (dentro de la sección de mueble actual)
        function agregarHerrajeItem(categoria) {
            const containerId = `current-mueble-${categoria}-container`; // Usar el nuevo ID
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Contenedor para la categoría "${categoria}" del mueble actual no encontrado.`);
                return;
            }

            const div = document.createElement('div');
            div.className = 'herraje-item flex items-center gap-2 mb-3'; // Usar flexbox y gap
            div.innerHTML = `
                <select onchange="toggleCustomMaterialInputs(this, 'herraje')" class="flex-grow p-2 border border-gray-300 rounded-md">
                    <option value="">-- Seleccionar Herraje --</option>
                    ${Object.entries(materiales.herrajes[categoria] || {}).map(([id, item]) =>
                        `<option value="${id}">${item.nombre} ($${materiales.herrajes[categoria][id].precio.toFixed(2)})</option>`
                    ).join('')}
                    <option value="custom">Otro (Valor Personalizado)</option>
                </select>
                <input type="number" min="0" step="1" value="0" placeholder="Cantidad" class="w-24 p-2 border border-gray-300 rounded-md text-center">
                <button class="btn-delete bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded" onclick="this.parentElement.remove()">×</button>
                 <div class="custom-material-inputs">
                     <input type="text" class="custom-nombre p-2 border border-gray-300 rounded-md" placeholder="Nombre">
                     <input type="number" class="custom-precio p-2 border border-gray-300 rounded-md" min="0" step="0.01" value="0" placeholder="Precio Unitario">
                     <input type="number" class="custom-cantidad p-2 border border-gray-300 rounded-md" min="0" step="1" value="0" placeholder="Cantidad">
                 </div>
            `;
            container.appendChild(div);
        }

        // Función para mostrar/ocultar los inputs de material personalizado
        function toggleCustomMaterialInputs(selectElement, tipoMaterial) {
            const parentDiv = selectElement.parentElement;
            const cantidadInput = parentDiv.querySelector('input[type="number"]');
            const customInputsDiv = parentDiv.querySelector('.custom-material-inputs');


            if (selectElement.value === 'custom') {
                customInputsDiv.style.display = 'grid'; // Mostrar los inputs personalizados
                cantidadInput.style.display = 'none'; // Ocultar el input de cantidad estándar
            } else {
                customInputsDiv.style.display = 'none'; // Ocultar los inputs personalizados
                cantidadInput.style.display = 'block'; // Mostrar el input de cantidad estándar
                 // Resetear los inputs personalizados a vacío/0 cuando se selecciona uno predefinido
                 customInputsDiv.querySelector('.custom-nombre').value = '';
                 customInputsDiv.querySelector('.custom-precio').value = '0';
                 customInputsDiv.querySelector('.custom-cantidad').value = '0';
            }
        }


        // Función para actualizar la lista de muebles mostrada en la interfaz
        function actualizarListaMuebles() {
            console.log("Actualizando lista de muebles..."); // Debug log
            const listaMuebles = document.getElementById('lista-muebles');

            // Safely get percentage values, checking if elements exist
            const gananciaInput = document.getElementById('ganancia');
            const porcentajeGanancia = gananciaInput ? parseFloat(gananciaInput.value) || 0 : 0;

            const descuentoInput = document.getElementById('descuento');
            const porcentajeDescuento = descuentoInput ? parseFloat(descuentoInput.value) || 0 : 0;


            listaMuebles.innerHTML = ''; // Limpiar la lista actual

            // Mostrar mensaje si no hay muebles
            if (muebles.length === 0) {
                listaMuebles.innerHTML = '<p class="text-gray-600">No hay muebles agregados</p>';
                document.getElementById('total-cotizacion').textContent = '$0.00';
                // Ocultar la sección de materiales de producción si no hay muebles
                document.getElementById('materials-list-section').style.display = 'none';
                // document.getElementById('consolidated-materials-section').style.display = 'none'; // Ocultar la nueva sección - REMOVED
                console.log("No hay muebles, lista vacía."); // Debug log
                return;
            }

            let totalCotizacion = 0;

            // Iterar sobre cada mueble y mostrar sus detalles
            muebles.forEach((mueble, index) => {
                const importeEsteMueble = calcularImporteMueble(mueble, porcentajeGanancia);
                totalCotizacion += importeEsteMueble;

                // Crear lista de tableros usados para mostrar
                let tablerosUsados = [];
                for (const tablero of mueble.tableros) {
                    if (tablero.cantidad > 0) {
                         let nombreMaterial = tablero.tipo && materiales.tableros[tablero.tipo] ? materiales.tableros[tablero.tipo].nombre : `${tablero.nombre} (Personalizado)`;
                         let precioUnitario = tablero.tipo && materiales.tableros[tablero.tipo] ? materiales.tableros[tablero.tipo].precio : tablero.precio;
                         tablerosUsados.push(`${tablero.cantidad} de ${nombreMaterial} ($${precioUnitario.toFixed(2)})`);
                    }
                }

                 // Crear lista de cantos usados para mostrar
                 let cantosUsados = [];
                 for (const canto of mueble.cantos) {
                      if (canto.cantidad > 0) {
                          let nombreMaterial = canto.tipo && materiales.cantos[canto.tipo] ? materiales.cantos[canto.tipo].nombre : `${canto.nombre} (Personalizado)`;
                          let precioUnitario = canto.tipo && materiales.cantos[canto.tipo] ? materiales.cantos[canto.tipo].precio : canto.precio;
                          cantosUsados.push(`${canto.cantidad.toFixed(2)} ML ${nombreMaterial} ($${precioUnitario.toFixed(2)})`);
                      }
                 }


                // Crear lista de herrajes usados para mostrar
                let herrajesUsados = [];
                for (const herraje of mueble.herrajes) {
                     const categoria = herraje.categoria;
                     if (herraje.cantidad > 0) {
                         let nombreMaterial = herraje.tipo && materiales.herrajes[categoria] && materiales.herrajes[categoria][herraje.tipo] ? materiales.herrajes[categoria][herraje.tipo].nombre : `${herraje.nombre} (Personalizado)`;
                         let precioUnitario = herraje.tipo && materiales.herrajes[categoria] && materiales.herrajes[categoria][herraje.tipo] ? materiales.herrajes[categoria][herraje.tipo].precio : herraje.precio;
                          herrajesUsados.push(`${herraje.cantidad} ${nombreMaterial} ($${precioUnitario.toFixed(2)})`);
                     }
                }

                // Mostrar costos adicionales si existen
                let costosAdicionalesHtml = '';
                if (mueble.transporte > 0) {
                    costosAdicionalesHtml += `<p class="text-gray-700"><strong>Costo de Transporte:</strong> $${mueble.transporte.toFixed(2)}</p>`;
                }
                 if (mueble.instalacion > 0) {
                    costosAdicionalesHtml += `<p class="text-gray-700"><strong>Costo de Instalación:</strong> $${mueble.instalacion.toFixed(2)}</p>`;
                 }


                // Crear el elemento HTML para el mueble (usando un diseño de tarjeta mejorado)
                const muebleElement = document.createElement('div');
                muebleElement.className = 'mueble-item border border-gray-300 p-5 mb-5 rounded-lg bg-gray-50 relative shadow-sm';
                muebleElement.innerHTML = `
                    <h3 class="text-xl font-semibold text-blue-700 mb-2">${mueble.nombre} (x${mueble.cantidad})</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <p class="text-gray-700"><strong>Tableros:</strong> ${tablerosUsados.join(', ') || 'Ninguno'}</p>
                        <p class="text-gray-700"><strong>Cantos:</strong> ${cantosUsados.join(', ') || 'Ninguno'}</p>
                        <p class="text-gray-700 md:col-span-2"><strong>Herrajes:</strong> ${herrajesUsados.join(', ') || 'Ninguno'}</p>
                        ${costosAdicionalesHtml ? `<div class="md:col-span-2">${costosAdicionalesHtml}</div>` : ''}
                    </div>
                    <p class="text-lg font-bold text-green-700 mt-3 text-right">Precio por ${mueble.cantidad} unidad(es): $${importeEsteMueble.toFixed(2)}</p>
                    <button class="btn-delete bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded absolute top-4 right-4" data-index="${index}" onclick="eliminarMueble(${index})">Eliminar</button>
                `;

                listaMuebles.appendChild(muebleElement);
            });

            // Apply discount to the total
            const subtotal = totalCotizacion; // Subtotal is the sum before discount
            const montoDescuento = subtotal * (porcentajeDescuento / 100);
            const totalConDescuento = subtotal - montoDescuento;


            // Actualizar el total de la cotización (Subtotal antes de descuento)
            document.getElementById('total-cotizacion').textContent = `$${totalConDescuento.toFixed(2)}`; // Show total after discount
            console.log("Lista de muebles actualizada. Total:", totalConDescuento); // Debug log

            // Actualizar la lista de materiales consolidados - REMOVED CALL
            // actualizarListaMaterialesConsolidados();
        }

        // Función para eliminar un mueble de la lista de la cotización actual
        function eliminarMueble(index) {
            console.log("Eliminando mueble en índice:", index); // Debug log
            muebles.splice(index, 1); // Eliminar el mueble del array
            actualizarListaMuebles(); // Actualizar la interfaz (lista de muebles y total)
            // Opcional: Ocultar la lista de materiales si ya no hay muebles
            if (muebles.length === 0) {
                 document.getElementById('materials-list-section').style.display = 'none';
                 // document.getElementById('consolidated-materials-section').style.display = 'none'; // Ocultar la nueva sección - REMOVED
            }
             console.log("Mueble eliminado. Array de muebles:", muebles); // Debug log
        }

        // Función para mostrar el formulario modal para actualizar precios
        function mostrarFormularioPrecios() {
            console.log("Mostrando formulario de precios..."); // Debug log
            let html = '<div class="dialogo-contenido bg-white p-8 rounded-lg shadow-xl max-w-2xl max-h-screen overflow-y-auto">';
            html += '<h2 class="text-2xl font-bold text-green-600 mb-5 border-b-2 border-green-500 pb-2">Actualizar Precios Base</h2>';

            // Sección de tableros en el formulario de precios
            html += '<h3 class="text-lg font-semibold text-gray-700 mt-5 mb-3">Tableros</h3>';
            // Asegurarse de usar el objeto materiales actual (que puede haber sido cargado de localStorage)
            for (const [id, tablero] of Object.entries(materiales.tableros)) {
                html += `
                    <div class="precio-item grid grid-cols-2 gap-4 items-center mb-3">
                        <label class="block text-gray-700">${tablero.nombre}</label>
                        <input type="number" step="0.01" id="precio-tablero-${id}" value="${materiales.tableros[id].precio.toFixed(2)}" class="p-2 border border-gray-300 rounded-md w-full">
                    </div>
                `;
            }

             // Sección de cantos en el formulario de precios
             html += '<h3 class="text-lg font-semibold text-gray-700 mt-5 mb-3">Cantos</h3>';
             // Asegurarse de usar el objeto materiales actual
             for (const [id, canto] of Object.entries(materiales.cantos)) {
                 html += `
                     <div class="precio-item grid grid-cols-2 gap-4 items-center mb-3">
                         <label class="block text-gray-700">${canto.nombre}</label>
                         <input type="number" step="0.01" id="precio-canto-${id}" value="${materiales.cantos[id].precio.toFixed(2)}" class="p-2 border border-gray-300 rounded-md w-full">
                     </div>
                 `;
             }


            // Sección de herrajes en el formulario de precios
            // Asegurarse de usar el objeto materiales actual
            for (const [categoria, herrajes] of Object.entries(materiales.herrajes)) {
                // Capitalizar la primera letra de la categoría para el título
                html += `<h3 class="text-lg font-semibold text-gray-700 mt-5 mb-3">${categoria.charAt(0).toUpperCase() + categoria.slice(1)}</h3>`;

                for (const [id, herraje] of Object.entries(herrajes)) {
                     // Asegurarse de usar el objeto materiales actual
                    html += `
                        <div class="precio-item grid grid-cols-2 gap-4 items-center mb-3">
                            <label class="block text-gray-700">${herraje.nombre}</label>
                            <input type="number" step="0.01" id="precio-${categoria}-${id}" value="${materiales.herrajes[categoria][id].precio.toFixed(2)}" class="p-2 border border-gray-300 rounded-md w-full">
                        </div>
                    `;
                }
            }

            // Botones del formulario de precios
            html += '<button id="btn-guardar-precios" class="btn-primary btn-material bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-6">Guardar Precios</button>';
            html += '<button id="btn-cerrar-dialogo" class="btn-delete btn-material bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded ml-4">Cerrar</button>';
            html += '</div>';

            // Crear y mostrar el elemento del diálogo
            const dialogo = document.createElement('div');
            dialogo.className = 'dialogo-precios'; // Clase CSS para el fondo oscuro y centrado
            dialogo.innerHTML = html;
            document.body.appendChild(dialogo);

            // Event listener para el botón de guardar precios en el diálogo
            document.getElementById('btn-guardar-precios').addEventListener('click', async function() { // Added async
                console.log("Guardando precios desde el diálogo..."); // Debug log
                // Actualizar precios de tableros desde los inputs del diálogo
                for (const id of Object.keys(materiales.tableros)) {
                    const inputElement = document.getElementById(`precio-tablero-${id}`);
                    if (inputElement) {
                        const nuevoPrecio = parseFloat(inputElement.value);
                        if (!isNaN(nuevoPrecio)) {
                            materiales.tableros[id].precio = nuevoPrecio;
                        }
                    }
                }

                 // Actualizar precios de cantos desde los inputs del diálogo
                 for (const id of Object.keys(materiales.cantos)) {
                     const inputElement = document.getElementById(`precio-canto-${id}`);
                     if (inputElement) {
                         const nuevoPrecio = parseFloat(inputElement.value);
                         if (!isNaN(nuevoPrecio)) {
                             materiales.cantos[id].precio = nuevoPrecio;
                         }
                     }
                 }


                // Actualizar precios de herrajes desde los inputs del diálogo
                for (const [categoria, herrajes] of Object.entries(materiales.herrajes)) {
                    for (const id of Object.keys(herrajes)) {
                         const inputElement = document.getElementById(`precio-${categoria}-${id}`);
                         if (inputElement) {
                            const nuevoPrecio = parseFloat(inputElement.value);
                            if (!isNaN(nuevoPrecio)) {
                                materiales.herrajes[categoria][id].precio = nuevoPrecio;
                            }
                         }
                    }
                }

                // Guardar los precios actualizados en IndexedDB
                try {
                    await guardarPrecios(); // Await the async function
                    console.log("Precios guardados en IndexedDB después de actualizar."); // Debug log
                    // Cerrar el diálogo
                    document.body.removeChild(dialogo);
                    actualizarListaMuebles(); // Actualizar la cotización actual con los nuevos precios y la lista consolidada
                    alert('Precios actualizados correctamente');
                } catch (e) {
                    console.error("Error al guardar precios después de actualizar en diálogo:", e); // Debug log
                    alert('Error al guardar los precios.');
                }
            });

            // Event listener para el botón de cerrar diálogo
            document.getElementById('btn-cerrar-dialogo').addEventListener('click', function() {
                console.log("Cerrando formulario de precios."); // Debug log
                document.body.removeChild(dialogo);
            });
        }


        // Función para generar la lista detallada de materiales para producción (en la interfaz)
        function generarListaMateriales() {
            console.log("Generando lista de materiales por mueble..."); // Debug log
            if (muebles.length === 0) {
                alert('No hay muebles para generar la lista de materiales');
                document.getElementById('materials-list-section').style.display = 'none'; // Ocultar la sección si no hay muebles
                console.log("No hay muebles para lista de materiales."); // Debug log
                return;
            }

            const listaMaterialesDiv = document.getElementById('materiales-produccion-lista');
            listaMaterialesDiv.innerHTML = ''; // Limpiar la lista actual

            // Iterar sobre cada mueble agregado
            muebles.forEach((mueble, index) => {
                const muebleMaterialsDiv = document.createElement('div');
                muebleMaterialsDiv.className = 'mueble-materials border border-gray-300 p-4 mb-5 rounded-lg bg-white shadow-sm';


                // Título para el mueble
                muebleMaterialsDiv.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-3 border-b border-dashed border-gray-300 pb-2">${mueble.nombre} (x${mueble.cantidad})</h3>`;


                let materialsHtml = '<ul class="list-disc pl-5">'; // Usar lista con viñetas y padding

                // Listar tableros para este mueble
                materialsHtml += '<li class="font-bold text-gray-700 mb-1">Tableros:</li>';
                if (mueble.tableros.length > 0) {
                    for (const tablero of mueble.tableros) {
                        let nombreMaterial, precioUnitario, cantidadTotal, subtotal;
                        if (tablero.tipo && materiales.tableros[tablero.tipo]) {
                            nombreMaterial = materiales.tableros[tablero.tipo].nombre;
                            precioUnitario = materiales.tableros[tablero.tipo].precio;
                            cantidadTotal = tablero.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                            subtotal = cantidadTotal * precioUnitario;
                             materialsHtml += `<li class="ml-4 text-gray-600">- ${nombreMaterial}: ${cantidadTotal} unidad(es) @ $${precioUnitario.toFixed(2)} = $${subtotal.toFixed(2)}</li>`;
                        } else if (tablero.nombre && tablero.precio !== undefined) { // Material personalizado
                            nombreMaterial = `${tablero.nombre} (Personalizado)`;
                            precioUnitario = tablero.precio;
                            cantidadTotal = tablero.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                            subtotal = cantidadTotal * precioUnitario;
                            materialsHtml += `<li class="ml-4 text-gray-600">- ${nombreMaterial}: ${cantidadTotal} unidad(es) @ $${precioUnitario.toFixed(2)} = $${subtotal.toFixed(2)}</li>`;
                        }
                    }
                } else {
                    materialsHtml += '<li class="ml-4 text-gray-600">- Ninguno</li>';
                }

                // Listar cantos para este mueble
                materialsHtml += '<li class="font-bold text-gray-700 mt-3 mb-1">Cantos (ML):</li>';
                if (mueble.cantos.length > 0) {
                    for (const canto of mueble.cantos) {
                        let nombreMaterial, precioUnitario, cantidadTotal, subtotal;
                        if (canto.tipo && materiales.cantos[canto.tipo]) {
                            nombreMaterial = materiales.cantos[canto.tipo].nombre;
                            precioUnitario = materiales.cantos[canto.tipo].precio;
                            cantidadTotal = canto.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                            subtotal = cantidadTotal * precioUnitario;
                            materialsHtml += `<li class="ml-4 text-gray-600">- ${nombreMaterial}: ${cantidadTotal.toFixed(2)} ML @ $${precioUnitario.toFixed(2)} = $${subtotal.toFixed(2)}</li>`;
                         } else if (canto.nombre && canto.precio !== undefined) { // Material personalizado
                             nombreMaterial = `${canto.nombre} (Personalizado)`;
                             precioUnitario = canto.precio;
                             cantidadTotal = canto.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                             subtotal = cantidadTotal * precioUnitario;
                             materialsHtml += `<li class="ml-4 text-gray-600">- ${nombreMaterial}: ${cantidadTotal.toFixed(2)} ML @ $${precioUnitario.toFixed(2)} = $${subtotal.toFixed(2)}</li>`;
                         }
                    }
                } else {
                     materialsHtml += '<li class="ml-4 text-gray-600">- Ninguno</li>';
                }


                // Listar herrajes para este mueble
                materialsHtml += '<li class="font-bold text-gray-700 mt-3 mb-1">Herrajes:</li>';
                // Consolidar herrajes por categoría para mostrar agrupados
                const herrajesAgrupados = {};
                mueble.herrajes.forEach(herraje => {
                    // Usar el nombre o tipo para agrupar, prefiriendo el nombre si es personalizado
                    const categoriaKey = herraje.categoria || 'otros'; // Usar 'otros' si no hay categoría definida (para personalizados sin categoría)
                    if (!herrajesAgrupados[categoriaKey]) {
                        herrajesAgrupados[categoriaKey] = [];
                    }
                    herrajesAgrupados[categoriaKey].push(herraje);
                });

                const herrajeCategorias = Object.keys(herrajesAgrupados);
                 if (herrajeCategorias.length > 0) {
                     herrajeCategorias.forEach(categoria => {
                         const itemsCategoria = herrajesAgrupados[categoria];
                         if (itemsCategoria.length > 0) {
                             // Mostrar el título de la categoría (capitalizado)
                              materialsHtml += `<li class="ml-4 text-gray-700">&nbsp;&nbsp;&nbsp;<strong>${categoria.charAt(0).toUpperCase() + categoria.slice(1)}:</strong></li>`;
                              itemsCategoria.forEach(herraje => {
                                  let nombreMaterial, precioUnitario, cantidadTotal, subtotal;
                                  if (herraje.tipo && materiales.herrajes[categoria] && materiales.herrajes[categoria][herraje.tipo]) {
                                      nombreMaterial = materiales.herrajes[categoria][herraje.tipo].nombre;
                                      precioUnitario = materiales.herrajes[categoria][herraje.tipo].precio;
                                       cantidadTotal = herraje.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                                      subtotal = cantidadTotal * precioUnitario;
                                      materialsHtml += `<li class="ml-8 text-gray-600">- ${nombreMaterial}: ${cantidadTotal} unidad(es) @ $${precioUnitario.toFixed(2)} = $${subtotal.toFixed(2)}</li>`;
                                  } else if (herraje.nombre && herraje.precio !== undefined) { // Material personalizado
                                      nombreMaterial = `${herraje.nombre} (Personalizado)`;
                                      precioUnitario = herraje.precio;
                                       cantidadTotal = herraje.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                                      subtotal = cantidadTotal * precioUnitario;
                                      materialsHtml += `<li class="ml-8 text-gray-600">- ${nombreMaterial}: ${cantidadTotal} unidad(es) @ $${precioUnitario.toFixed(2)} = $${subtotal.toFixed(2)}</li>`;
                                  }
                              });
                         }
                     });
                } else {
                    materialsHtml += '<li class="ml-4 text-gray-600">- Ninguno</li>';
                }

                // Mostrar costos adicionales en la lista de materiales de producción (opcional, pero útil)
                 if (mueble.transporte > 0 || mueble.instalacion > 0) {
                     materialsHtml += '<li class="font-bold text-gray-700 mt-3 mb-1">Costos Adicionales por Mueble:</li>'; // Título actualizado
                     if (mueble.transporte > 0) {
                          materialsHtml += `<li class="ml-4 text-gray-600">- Transporte: $${(mueble.transporte * mueble.cantidad).toFixed(2)}</li>`; // Multiplicar por cantidad de muebles
                     }
                      if (mueble.instalacion > 0) {
                          materialsHtml += `<li class="ml-4 text-gray-600">- Instalación: $${(mueble.instalacion * mueble.cantidad).toFixed(2)}</li>`; // Multiplicar por cantidad de muebles
                     }
                 }


                materialsHtml += '</ul>';
                muebleMaterialsDiv.innerHTML += materialsHtml;
                listaMaterialesDiv.appendChild(muebleMaterialsDiv);
            });


            // Mostrar la sección de lista de materiales
            document.getElementById('materials-list-section').style.display = 'block';
            console.log("Lista de materiales por mueble generada."); // Debug log
        }

        // Función para actualizar la lista de materiales consolidados en la interfaz - REMOVED
        /*
        function actualizarListaMaterialesConsolidados() {
             console.log("Actualizando lista de materiales consolidados..."); // Debug log
             const consolidatedMaterialsDiv = document.getElementById('consolidated-materials-list');
             const consolidatedSection = document.getElementById('consolidated-materials-section');
             consolidatedMaterialsDiv.innerHTML = ''; // Limpiar la lista actual

             if (muebles.length === 0) {
                 consolidatedSection.style.display = 'none'; // Ocultar si no hay muebles
                 console.log("No hay muebles, sección de materiales consolidados oculta."); // Debug log
                 return;
             }

             const materialesConsolidados = consolidarMateriales(muebles);

             let html = '<ul class="list-disc pl-5">';

             // Mostrar tableros consolidados
             const tablerosKeys = Object.keys(materialesConsolidados.tableros);
             if (tablerosKeys.length > 0) {
                 html += '<li class="font-bold text-gray-700 mb-1">Tableros:</li>';
                 for (const key of tablerosKeys) {
                     const item = materialesConsolidados.tableros[key];
                     html += `<li class="ml-4 text-gray-600">- ${item.nombre}: ${item.cantidad} unidad(es)</li>`;
                 }
             }

             // Mostrar cantos consolidados
             const cantosKeys = Object.keys(materialesConsolidados.cantos);
             if (cantosKeys.length > 0) {
                 html += '<li class="font-bold text-gray-700 mt-3 mb-1">Cantos (ML):</li>';
                 for (const key of cantosKeys) {
                     const item = materialesConsolidados.cantos[key];
                     html += `<li class="ml-4 text-gray-600">- ${item.nombre}: ${item.cantidad.toFixed(2)} ML</li>`;
                 }
             }

             // Mostrar herrajes consolidados por categoría
             const herrajesCategorias = Object.keys(materialesConsolidados.herrajes);
             if (herrajesCategorias.length > 0) {
                 html += '<li class="font-bold text-gray-700 mt-3 mb-1">Herrajes:</li>';
                 herrajesCategorias.forEach(categoria => {
                     const itemsCategoria = herrajesAgrupados[categoria];
                     const itemsKeys = Object.keys(itemsCategoria);
                     if (itemsKeys.length > 0) {
                         html += `<li class="ml-4 text-gray-700">&nbsp;&nbsp;&nbsp;<strong>${categoria.charAt(0).toUpperCase() + categoria.slice(1)}:</strong></li>`;
                         for (const key of itemsKeys) {
                             const item = itemsCategoria[key];
                             html += `<li class="ml-8 text-gray-600">- ${item.nombre}: ${item.cantidad} unidad(es)</li>`;
                         }
                     }
                 });
             }


             html += '</ul>';
             consolidatedMaterialsDiv.innerHTML = html;

             // Mostrar la sección consolidada
             consolidatedSection.style.display = 'block';
             console.log("Lista de materiales consolidados actualizada."); // Debug log
        }
        */


        // Función para formatear una fecha como DD/MM/YYYY
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // getMonth() es base 0
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }


        // ======================================================================
        // Funciones de Guardar/Cargar/Eliminar Cotizaciones (usando IndexedDB)
        // ======================================================================

        // Función para cargar precios desde IndexedDB
        async function cargarPrecios() {
            console.log("Cargando precios desde IndexedDB..."); // Debug log
            try {
                // Intentar obtener el objeto de precios (asumimos que solo hay uno con un ID fijo)
                const preciosGuardados = await getObjectFromStore(preciosStoreName, 'materialPrices');

                if (preciosGuardados) {
                    // Fusionar precios cargados con la estructura actual, manteniendo solo materiales permitidos
                    for (const type in materiales.tableros) {
                       if (preciosGuardados.tableros && preciosGuardados.tableros[type]) {
                           materiales.tableros[type].precio = preciosGuardados.tableros[type].precio;
                       }
                    }
                    for (const type in materiales.cantos) {
                       if (preciosGuardados.cantos && preciosGuardados.cantos[type]) {
                           materiales.cantos[type].precio = preciosGuardados.cantos[type].precio;
                       }
                    }
                    for (const category in materiales.herrajes) {
                       if (preciosGuardados.herrajes && preciosGuardados.herrajes[category]) {
                           for (const type in materiales.herrajes[category]) {
                               if (preciosGuardados.herrajes[category][type]) {
                                   materiales.herrajes[category][type].precio = preciosGuardados.herrajes[category][type].precio;
                               }
                           }
                       }
                    }
                    console.log("Precios cargados y fusionados desde IndexedDB:", materiales);
                } else {
                    console.log("No se encontraron precios guardados en IndexedDB. Usando precios predeterminados.");
                }
            } catch (e) {
                console.error("Error al cargar precios desde IndexedDB:", e);
                // Si hay un error, se usarán los precios predeterminados definidos globalmente
            }
        }

        // Función para guardar precios en IndexedDB
        async function guardarPrecios() {
            console.log("Guardando precios en IndexedDB..."); // Debug log
            try {
                // Guardar todo el objeto de materiales con un ID fijo para poder recuperarlo
                const preciosParaGuardar = { id: 'materialPrices', ...materiales };
                await putDataInStore(preciosStoreName, preciosParaGuardar);
                console.log("Precios guardados en IndexedDB.");
            } catch (e) {
                console.error("Error al guardar precios en IndexedDB:", e);
                alert("No se pudieron guardar los precios.");
            }
        }

        // Función para cargar cotizaciones guardadas desde IndexedDB
        async function cargarCotizacionesGuardadas() {
            console.log("Cargando cotizaciones guardadas desde IndexedDB..."); // Debug log
            try {
                cotizacionesGuardadas = await getDataFromStore(cotizacionesStoreName);
                console.log("Cotizaciones guardadas cargadas desde IndexedDB:", cotizacionesGuardadas);
            } catch (e) {
                console.error("Error al cargar cotizaciones desde IndexedDB:", e);
                cotizacionesGuardadas = []; // Reiniciar si hay error
            } finally {
                 actualizarListaCotizacionesGuardadas(); // Actualizar la UI con las cotizaciones cargadas (o vacías si hubo error)
                 console.log("Lista de cotizaciones guardadas actualizada en UI."); // Debug log
            }
        }

        // Función para guardar una cotización actual en IndexedDB
        async function guardarCotizacionActual() {
             console.log("Iniciando guardado de cotización actual..."); // Debug log
             // Obtener datos de la cotización actual
             const clienteNombre = document.getElementById('cliente-nombre').value.trim();
             const clienteTelefono = document.getElementById('cliente-telefono').value.trim();
             const clienteDireccion = document.getElementById('cliente-direccion').value.trim();
             const porcentajeGanancia = parseFloat(document.getElementById('ganancia').value) || 0;
             const porcentajeDescuento = parseFloat(document.getElementById('descuento').value) || 0;

             // Validar que haya al menos un mueble y un nombre de cliente para guardar
             if (muebles.length === 0) {
                 alert('No hay muebles en la cotización actual para guardar.');
                 console.log("Guardar cotización cancelado: No hay muebles."); // Debug log
                 return;
             }
              if (!clienteNombre) {
                  alert('Por favor, ingresa el nombre del cliente para guardar la cotización.');
                  console.log("Guardar cotización cancelado: Nombre del cliente vacío."); // Debug log
                  return;
              }

             // Crear un ID único para la cotización (timestamp es simple y efectivo)
             const id = Date.now();

             // Crear el objeto de cotización
             const cotizacion = {
                 id: id,
                 fecha: new Date().toISOString(), // Guardar fecha en formato ISO
                 nombreCliente: clienteNombre,
                 telefonoCliente: clienteTelefono,
                 direccionCliente: clienteDireccion,
                 porcentajeGanancia: porcentajeGanancia,
                 porcentajeDescuento: porcentajeDescuento,
                 muebles: JSON.parse(JSON.stringify(muebles)) // Copiar el array de muebles
             };

             console.log("Objeto de cotización a guardar:", cotizacion); // Debug log

             try {
                 await putDataInStore(cotizacionesStoreName, cotizacion);
                 console.log("Cotización guardada en IndexedDB:", cotizacion);

                 // Recargar la lista de cotizaciones guardadas desde IndexedDB
                 await cargarCotizacionesGuardadas();

                 alert('Cotización guardada correctamente.');
                 console.log("Guardado de cotización actual finalizado con éxito."); // Debug log
             } catch (e) {
                 console.error("Error al guardar cotización en IndexedDB:", e);
                 alert('No se pudo guardar la cotización.');
             }
        }

        // Función para cargar una cotización guardada desde IndexedDB
        async function cargarCotizacion(id) {
            console.log("Iniciando carga de cotización con ID:", id); // Debug log
            try {
                const cotizacionACargar = await getObjectFromStore(cotizacionesStoreName, id);

                if (cotizacionACargar) {
                    console.log("Cotización encontrada en IndexedDB:", cotizacionACargar); // Debug log
                    // Cargar datos en el formulario
                    document.getElementById('cliente-nombre').value = cotizacionACargar.nombreCliente;
                    document.getElementById('cliente-telefono').value = cotizacionACargar.telefonoCliente;
                    document.getElementById('cliente-direccion').value = cotizacionACargar.direccionCliente;
                    document.getElementById('ganancia').value = cotizacionACargar.porcentajeGanancia;
                    document.getElementById('descuento').value = cotizacionACargar.porcentajeDescuento;

                    // Cargar los muebles de la cotización guardada
                    muebles = JSON.parse(JSON.stringify(cotizacionACargar.muebles)); // Copiar el array de muebles
                    console.log("Muebles cargados:", muebles); // Debug log

                    // Limpiar los inputs de materiales en el formulario actual antes de cargar los nuevos
                     document.querySelectorAll('.dynamic-items-container').forEach(container => {
                         container.innerHTML = ''; // Limpiar completamente el contenedor
                     });
                     console.log("Contenedores dinámicos limpiados."); // Debug log

                     // --- Añadir los items dinámicos iniciales nuevamente ---
                     agregarTableroItem();
                     agregarCantoItem();
                     agregarHerrajeItem('correderas');
                     agregarHerrajeItem('bisagras');
                     agregarHerrajeItem('tiradores');
                     agregarHerrajeItem('otros');
                     console.log("Items dinámicos iniciales agregados."); // Debug log
                     // ----------------------------------------------------

                    // Limpiar los campos del formulario de mueble actual
                    document.getElementById('nombre').value = '';
                    document.getElementById('cantidad-mueble').value = '1';
                    document.getElementById('costo-transporte').value = '0';
                    document.getElementById('costo-instalacion').value = '0';


                    // Actualizar la lista de muebles mostrada en la interfaz
                    actualizarListaMuebles();

                    // Ocultar la lista de materiales de producción si estaba visible
                     document.getElementById('materials-list-section').style.display = 'none';
                     // document.getElementById('consolidated-materials-section').style.display = 'block'; // Asegurarse de que la consolidada se muestre si hay muebles - REMOVED
                     console.log("Sección de materiales de producción oculta."); // Debug log


                    alert(`Cotización de "${cotizacionACargar.nombreCliente}" cargada.`);
                    console.log("Carga de cotización finalizada con éxito."); // Debug log
                } else {
                    console.warn("Cotización con ID no encontrada en IndexedDB:", id); // Debug log
                    alert('Error: Cotización no encontrada en IndexedDB.');
                }
            } catch (e) {
                console.error("Error al cargar cotización desde IndexedDB:", e);
                alert('Error al cargar la cotización.');
            }
        }

        // Función para eliminar una cotización guardada de IndexedDB
        async function eliminarCotizacion(id) {
            console.log("Iniciando eliminación de cotización con ID:", id); // Debug log
            if (confirm('¿Estás seguro de que deseas eliminar esta cotización?')) {
                try {
                    await deleteDataFromStore(cotizacionesStoreName, id);
                    console.log(`Cotización con ID ${id} eliminada de IndexedDB.`);

                    // Recargar la lista de cotizaciones guardadas desde IndexedDB
                    await cargarCotizacionesGuardadas();

                    alert('Cotización eliminada.');
                    console.log("Eliminación de cotización finalizada con éxito."); // Debug log
                } catch (e) {
                    console.error("Error al eliminar cotización de IndexedDB:", e);
                    alert('No se pudo eliminar la cotización.');
                }
            } else {
                 console.log("Eliminación de cotización cancelada por el usuario."); // Debug log
            }
        }

        // Función para actualizar la lista de cotizaciones guardadas en la interfaz (ahora solo lee de cotizacionesGuardadas array)
        function actualizarListaCotizacionesGuardadas() {
            console.log("Actualizando lista de cotizaciones guardadas en UI..."); // Debug log
            const listaCotizaciones = document.getElementById('lista-cotizaciones-guardadas');
            listaCotizaciones.innerHTML = ''; // Limpiar la lista actual

            if (cotizacionesGuardadas.length === 0) {
                listaCotizaciones.innerHTML = '<p class="text-gray-600">No hay cotizaciones guardadas.</p>';
                console.log("No hay cotizaciones guardadas, lista vacía."); // Debug log
                return;
            }

            cotizacionesGuardadas.forEach(cotizacion => {
                const listItem = document.createElement('li');
                // Mostrar información relevante de la cotización guardada
                const fechaGuardado = new Date(cotizacion.fecha).toLocaleDateString(); // Formatear fecha
                listItem.innerHTML = `
                    <div class="quote-info">
                        <strong>${cotizacion.nombreCliente}</strong> (${fechaGuardado})
                        <p class="text-sm text-gray-600">${cotizacion.muebles.length} mueble(s)</p>
                    </div>
                    <div class="quote-actions">
                        <button class="btn-primary btn-material bg-blue-500 hover:bg-blue-700 text-white py-1 px-3 rounded" onclick="cargarCotizacion(${cotizacion.id})">Cargar</button>
                        <button class="btn-delete btn-material bg-red-500 hover:bg-red-700 text-white py-1 px-3 rounded" onclick="eliminarCotizacion(${cotizacion.id})">Eliminar</button>
                    </div>
                `;

                listaCotizaciones.appendChild(listItem);
            });
             console.log("Lista de cotizaciones guardadas en UI actualizada."); // Debug log
        }

        // ======================================================================
        // Funciones de Exportar/Importar Cotizaciones (usando IndexedDB)
        // ======================================================================

        // Función para exportar cotizaciones a un archivo JSON desde IndexedDB
        async function exportarCotizaciones() {
            console.log("Iniciando exportación de cotizaciones..."); // Debug log
            try {
                const allQuotes = await getDataFromStore(cotizacionesStoreName);

                if (allQuotes.length === 0) {
                    alert('No hay cotizaciones guardadas para exportar.');
                    console.log("Exportación cancelada: No hay cotizaciones guardadas."); // Debug log
                    return;
                }

                const dataStr = JSON.stringify(allQuotes, null, 2); // Convertir el array a JSON con formato legible
                const dataBlob = new Blob([dataStr], { type: 'application/json' }); // Crear un Blob con los datos
                const url = URL.createObjectURL(dataBlob); // Crear una URL para el Blob

                const a = document.createElement('a'); // Crear un enlace temporal
                a.href = url;
                a.download = 'cotizaciones_muebles.json'; // Nombre del archivo a descargar
                document.body.appendChild(a); // Añadir el enlace al cuerpo (necesario para Firefox)
                a.click(); // Simular un clic en el enlace para iniciar la descarga

                // Limpiar después de la descarga
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log("Cotizaciones exportadas desde IndexedDB.");

            } catch (e) {
                console.error("Error al exportar cotizaciones desde IndexedDB:", e);
                alert("No se pudieron exportar las cotizaciones.");
            }
        }

        // Función para importar cotizaciones desde un archivo JSON a IndexedDB
        function importarCotizaciones(event) {
            console.log("importarCotizaciones: Función iniciada.");
            const file = event.target.files[0];

            if (!file) {
                console.log("importarCotizaciones: No se seleccionó ningún archivo.");
                return;
            }

            console.log("importarCotizaciones: Archivo seleccionado:", file.name);

            const reader = new FileReader();

            reader.onload = async function(e) { // Usar async aquí
                console.log("importarCotizaciones: FileReader onload activado.");

                try {
                    console.log("importarCotizaciones: Intentando parsear JSON.");
                    const importedQuotes = JSON.parse(e.target.result);
                    console.log("importarCotizaciones: JSON parseado exitosamente:", importedQuotes);

                    if (!Array.isArray(importedQuotes)) {
                         console.warn("importarCotizaciones: El contenido del archivo no es un array.");
                         alert('El archivo seleccionado no parece contener cotizaciones válidas.');
                         return;
                    }
                    console.log("importarCotizaciones: El contenido del archivo es un array.");

                    const overwrite = confirm('¿Deseas sobrescribir las cotizaciones guardadas actuales con las del archivo? (Cancelar para fusionar)');
                    console.log("importarCotizaciones: Resultado del diálogo de confirmación:", overwrite);

                    if (overwrite) {
                        // Limpiar el object store antes de añadir los nuevos datos
                        await clearStore(cotizacionesStoreName);
                        console.log("importarCotizaciones: Sobrescribiendo cotizaciones (limpiando store).");
                    } else {
                        console.log("importarCotizaciones: Fusionando cotizaciones.");
                    }

                    // Añadir cada cotización importada a IndexedDB
                    // Usar una sola transacción para todas las operaciones de put es más eficiente
                    const transaction = db.transaction([cotizacionesStoreName], 'readwrite');
                    const objectStore = transaction.objectStore(cotizacionesStoreName);

                    importedQuotes.forEach(quote => {
                         // Asegurarse de que cada cotización tenga un ID (IndexedDB keyPath)
                         if (quote.id === undefined) {
                             // Generar un ID único si no lo tiene (ej: timestamp + random para evitar colisiones si se importa el mismo archivo varias veces)
                             quote.id = Date.now() + Math.random();
                             console.warn("Cotización importada sin ID, generando uno:", quote);
                         }
                         objectStore.put(quote); // Añadir o actualizar
                    });

                    transaction.oncomplete = async function() { // Usar async aquí
                        console.log("importarCotizaciones: Transacción de importación completada.");
                        // Recargar la lista de cotizaciones guardadas desde IndexedDB
                        await cargarCotizacionesGuardadas();
                        alert(overwrite ? 'Cotizaciones importadas (sobrescritas) correctamente.' : 'Cotizaciones importadas (fusionadas) correctamente.');
                        console.log("importarCotizaciones: Proceso de importación finalizado con éxito.");
                    };

                    transaction.onerror = function(event) {
                         console.error("importarCotizaciones: Error en la transacción de importación:", event.target.error);
                         alert('Error al importar cotizaciones durante la transacción.');
                    };


                } catch (error) {
                    console.error("importarCotizaciones: Error al procesar el archivo:", error);
                    alert('Error al procesar el archivo. Asegúrate de que es un archivo de cotizaciones válido.');
                }
            };

            reader.onerror = function(e) {
                console.error("importarCotizaciones: Error al leer el archivo:", e);
                alert('Error al leer el archivo.');
            };

            reader.readAsText(file);
        }


        // ======================================================================
        // Funciones de Generación de PDF
        // ======================================================================

        // Función para generar el documento PDF de la cotización (para el cliente)
        function generarPDF() {
            console.log("Generando PDF de cotización..."); // Debug log
            if (muebles.length === 0) {
                alert('No hay muebles para generar PDF');
                console.log("Generación de PDF cancelada: No hay muebles."); // Debug log
                return;
            }

            // Configurar jsPDF para tamaño carta
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'letter'); // 'p' para vertical, 'mm' para unidades, 'letter' para tamaño carta

             // Safely get percentage values for PDF generation
            const gananciaInput = document.getElementById('ganancia');
            const porcentajeGanancia = gananciaInput ? parseFloat(gananciaInput.value) || 0 : 0;

            const descuentoInput = document.getElementById('descuento');
            const porcentajeDescuento = descuentoInput ? parseFloat(descuentoInput.value) || 0 : 0;


            // Información de la empresa desde las constantes
            const empresaNombre = infoEmpresa.nombre;
            const empresaDireccion = infoEmpresa.direccion;
            const empresaTelefono = infoEmpresa.telefono;
            const empresaEmail = infoEmpresa.email;
            const empresaLogoUrl = infoEmpresa.logoUrl;


            // Información del cliente
            const clienteNombre = document.getElementById('cliente-nombre').value.trim();
            const clienteTelefono = document.getElementById('cliente-telefono').value.trim();
            const clienteDireccion = document.getElementById('cliente-direccion').value.trim();

            // Fechas de cotización y validez
            const fechaCreacion = new Date();
            const fechaValidez = new Date();
            fechaValidez.setDate(fechaCreacion.getDate() + 30); // Sumar 30 días

            const fechaCreacionFormatted = formatDate(fechaCreacion);
            const fechaValidezFormatted = formatDate(fechaValidez);


            // --- Encabezado del PDF ---

            // Agregar Logo si hay URL
            if (empresaLogoUrl) {
                try {
                     const img = new Image();
                     img.onload = function() {
                         // Ajustar posición y tamaño del logo
                         doc.addImage(img, 'PNG', 15, 10, 40, 40); // Posición (x, y), Ancho, Alto

                         // Continuar generando el resto del PDF después de cargar la imagen
                         addPdfContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacionFormatted, fechaValidezFormatted, porcentajeGanancia, porcentajeDescuento);

                         // Guardar el archivo PDF dentro del onload para asegurar que la imagen esté incluida
                         doc.save('cotizacion-muebles.pdf');
                         console.log("PDF de cotización generado con logo."); // Debug log
                     };
                     img.onerror = function() {
                         console.error("Error al cargar la imagen del logo. Asegúrate de que la URL es correcta y accesible.");
                         // Si la imagen falla en cargar, generar el PDF sin el logo
                         addPdfContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacionFormatted, fechaValidezFormatted, porcentajeGanancia, porcentajeDescuento);
                         doc.save('cotizacion-muebles.pdf');
                         console.warn("PDF de cotización generado sin logo debido a error de carga."); // Debug log
                     };
                     img.crossOrigin = ''; // Intenta habilitar CORS si la imagen está en otro dominio
                     img.src = empresaLogoUrl;

                } catch (e) {
                    console.error("Error al intentar añadir la imagen del logo:", e);
                    // Si hay un error en el try, generar el PDF sin el logo
                    addPdfContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacionFormatted, fechaValidezFormatted, porcentajeGanancia, porcentajeDescuento);
                    doc.save('cotizacion-muebles.pdf');
                    console.error("PDF de cotización generado sin logo debido a error en try-catch."); // Debug log
                }

            } else {
                 // Si no hay URL de logo, generar el PDF sin el logo
                 addPdfContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacionFormatted, fechaValidezFormatted, porcentajeGanancia, porcentajeDescuento);
                 doc.save('cotizacion-muebles.pdf');
                 console.log("PDF de cotización generado sin logo (no URL proporcionada)."); // Debug log
            }
        }

        // Función auxiliar para añadir el contenido del PDF (texto y tabla)
        function addPdfContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacionFormatted, fechaValidezFormatted, porcentajeGanancia, porcentajeDescuento) {
            console.log("Añadiendo contenido al PDF de cotización..."); // Debug log
            // Información de la empresa
            doc.setFontSize(10);
            // Ajustar la posición del texto de la empresa para dejar espacio al logo
            let empresaTextY = 10;
            // Si el logo se cargó correctamente (o si no había URL), ajustamos la posición del texto
            if (infoEmpresa.logoUrl) { // Verificamos si había una URL de logo definida
                empresaTextY = 55; // Ajusta este valor si es necesario para que no se solape con el logo
            }

            doc.text(empresaNombre, 15, empresaTextY);
            doc.text(empresaDireccion, 15, empresaTextY + 5);
            doc.text(`Teléfono: ${empresaTelefono}`, 15, empresaTextY + 10);
            doc.text(`Email: ${empresaEmail}`, 15, empresaTextY + 15);


            doc.setFontSize(20);
            // Ajustar posición del título "COTIZACION"
            doc.text('COTIZACION', doc.internal.pageSize.getWidth() - 15, 15, { align: 'right' }); // Alineado a la derecha


            doc.setFontSize(10);
             // Ajustar posición de las fechas
            doc.text(`FECHA: ${fechaCreacionFormatted}`, doc.internal.pageSize.getWidth() - 15, 25, { align: 'right' }); // Alineado a la derecha
            // Puedes añadir un número de presupuesto si tienes una lógica para generarlo
            // doc.text(`N.º de presupuesto: [Número]`, doc.internal.pageSize.getWidth() - 60, 30);
            doc.text(`Presupuesto válido hasta: ${fechaValidezFormatted}`, doc.internal.pageSize.getWidth() - 15, 35, { align: 'right' }); // Alineado a la derecha


            // Información del cliente en el PDF
            let currentY = Math.max(empresaTextY + 25, 45); // Empezar la info del cliente después de la empresa o en 45
            doc.setFontSize(12);
            doc.text('Información del Cliente:', 15, currentY);
            currentY += 7;
            if (clienteNombre) {
                doc.text(`Nombre: ${clienteNombre}`, 15, currentY);
                currentY += 7;
            }
             if (clienteTelefono) {
                doc.text(`Teléfono: ${clienteTelefono}`, 15, currentY);
                currentY += 7;
            }
             if (clienteDireccion) {
                doc.text(`Dirección: ${clienteDireccion}`, 15, currentY);
                currentY += 7;
            }
             // Añadir un espacio después de la información del cliente si se agregó alguna
             if (clienteNombre || clienteTelefono || clienteDireccion) {
                 currentY += 5;
             }


            // Preparar datos para la tabla del PDF con la nueva estructura
            const tableData = muebles.map(mueble => {
                const costoUnitario = calcularCostoUnitarioMueble(mueble, porcentajeGanancia);
                const importe = calcularImporteMueble(mueble, porcentajeGanancia);

                // En el PDF de cotización para el cliente, solo mostramos el nombre del mueble
                return [
                    mueble.cantidad, // Cantidad del mueble
                    mueble.nombre, // Descripción (solo nombre del mueble)
                    `$${costoUnitario.toFixed(2)}`, // Precio Unitario
                    `$${importe.toFixed(2)}` // Importe (Precio Unitario * Cantidad)
                ];
            });

            // Calcular Subtotal (Este subtotal ya incluye los costos adicionales por mueble, ya que se sumaron en calcularCostoUnitarioMueble)
            const subtotal = muebles.reduce((sum, mueble) => sum + calcularImporteMueble(mueble, porcentajeGanancia), 0);


            // Calcular Descuento
            const porcentajeDescuentoActual = parseFloat(document.getElementById('descuento').value) || 0;
            const montoDescuento = subtotal * (porcentajeDescuentoActual / 100);

            // Calcular Total General (Subtotal - Descuento)
            const totalGeneral = subtotal - montoDescuento;


            // Generar la tabla principal en el PDF
            doc.autoTable({
                startY: currentY, // Posición inicial de la tabla después de la info del cliente
                head: [['CANT.', 'DESCRIPCION', 'PRECIO UNITARIO', 'IMPORTE']], // Encabezados de la tabla
                body: tableData, // Datos de la tabla
                columnStyles: { // Estilos para las columnas
                    0: { cellWidth: 20, halign: 'center' }, // Cantidad centrada
                    1: { cellWidth: 80, halign: 'left' }, // Descripción alineada a la izquierda
                    2: { cellWidth: 40, halign: 'right' }, // Precio Unitario alineado a la derecha
                    3: { cellWidth: 40, halign: 'right' } // Importe alineado a la derecha
                },
                 headStyles: { // Estilos para el encabezado de la tabla
                     halign: 'center', // Centrar texto en los encabezados
                     fillColor: [52, 152, 219], // Color de fondo azul
                     textColor: [255, 255, 255] // Color de texto blanco
                 },
                 styles: { // Estilos generales de la tabla
                     lineWidth: 0.1, // Ancho de las líneas
                     lineColor: [0, 0, 0] // Color de las líneas (negro)
                 },
                 bodyStyles: { // Estilos para el cuerpo de la tabla
                     lineWidth: 0.1, // Asegurar líneas en el cuerpo
                     lineColor: [0, 0, 0]
                 },
                didDrawPage: function (data) {
                    // Opcional: añadir pie de página o encabezado en cada página
                }
            });

            // Añadir Subtotal, Descuento y Total General usando una tabla separada para mejor alineación y líneas
            const finalY = doc.lastAutoTable.finalY; // Obtener la posición Y final de la tabla
            // const pageWidth = doc.internal.pageSize.getWidth(); // Ancho de la página

            const totalsTableData = [
                ['SUB-TOTAL', `$${subtotal.toFixed(2)}`],
                 // Eliminada la fila de TOTAL TRANSPORTE E INSTALACIÓN
                ['DESCUENTOS', `$${montoDescuento.toFixed(2)} (${porcentajeDescuentoActual}%)`], // Mostrar porcentaje de descuento
                [{content: 'TOTAL GENERAL', styles: {fontStyle: 'bold'}}, `$${totalGeneral.toFixed(2)}`] // Total en negrita
            ];

             doc.autoTable({
                 startY: finalY + 5, // Empezar 5mm debajo de la tabla principal para separarla
                 body: totalsTableData, // Datos para la tabla de totales
                 theme: 'plain', // Usar tema 'plain' para controlar los bordes manualmente
                 styles: { // Estilos generales para la tabla de totales
                     // Eliminamos lineWidth y lineColor aquí para quitar los bordes
                     cellPadding: 2 // Mantener un padding si es necesario para el texto dentro de las celdas
                 },
                 columnStyles: { // Estilos para las columnas de la tabla de totales
                     // Ajustar cellWidth y margin.left para alinear correctamente con la tabla de arriba
                     // La primera columna de totales debe alinearse con el inicio de la columna "PRECIO UNITARIO"
                     // La segunda columna de totales debe tener el ancho de la columna "IMPORTE" y alinearse con ella
                     0: { cellWidth: 40, halign: 'right', fontStyle: 'bold' }, // Etiqueta (Subtotal, Descuentos, Total) alineada a la derecha y negrita
                     1: { cellWidth: 40, halign: 'right' } // Valor alineado a la derecha
                 },
                  // Calcular el margen izquierdo para que la primera columna de totales inicie donde inicia "PRECIO UNITARIO"
                  // Inicio de "PRECIO UNITARIO" = Margen Izquierdo (15) + Ancho CANT (20) + Ancho DESCRIPCION (80) = 115mm
                  margin: { left: 115 },
                  // Eliminamos tableLineWidth y tableLineColor para quitar los bordes de la tabla completa
                  // tableLineWidth: 0.1,
                  // tableLineColor: [0, 0, 0],
                  // No necesitamos didDrawPage aquí
             });

            // --- Añadir Términos y Condiciones ---
            // Calcular la posición Y para los términos y condiciones, asegurando que haya suficiente espacio
            let termsY = doc.lastAutoTable.finalY + 20; // Empezar 20mm debajo de la tabla de totales

            // Si la posición calculada más la altura estimada de los términos excede el final de la página, añadir una nueva página
            const estimatedTermsHeight = 40; // Estimar la altura necesaria para los términos (ajustar si es necesario)
            if (termsY + estimatedTermsHeight > doc.internal.pageSize.getHeight() - 15) { // 15mm de margen inferior
                 doc.addPage();
                 termsY = 15; // Empezar en la parte superior de la nueva página
            }


            doc.setFontSize(10);
            doc.setFont("helvetica", "bold"); // Negrita para el título de términos
            doc.text('Terminos y condiciones:', 15, termsY);
            termsY += 7; // Espacio después del título

            doc.setFont("helvetica", "normal"); // Volver a normal
            doc.text('• Los planos deberán ser aprobados y firmados por el cliente una vez realizado el levantamiento.', 15, termsY);
            termsY += 5;
            doc.text('• Cualquier modificación o ajuste posterior implicará un costo adicional.', 15, termsY);
            termsY += 5;
            doc.text('• Condiciones de pago: 70 % al inicio del proyecto y 30 % al finalizar el trabajo.', 15, termsY);
            termsY += 10; // Espacio después de las condiciones

            doc.setFont("helvetica", "bold"); // Negrita para el nombre
            doc.text('Jesus Vargas Alcántara', 15, termsY);
            termsY += 5;

            doc.setFont("helvetica", "normal"); // Volver a normal
            doc.text('Ced.: 22300660069', 15, termsY);
            termsY += 5;
            doc.text('Banco de Reservas: cuenta # 8900058450', 15, termsY);
            termsY += 5;
            doc.text('APAP: cuenta # 1028795572', 15, termsY);
             console.log("Contenido añadido al PDF de cotización."); // Debug log

        }

        // Función para generar el PDF de la lista de materiales detallada (MATRIZ DE PRODUCCION)
        function generarPDFListaMateriales() {
             console.log("Generando PDF de matriz de producción..."); // Debug log
             if (muebles.length === 0) {
                 alert('No hay muebles para generar la lista de materiales en PDF');
                 console.log("Generación de PDF de matriz de producción cancelada: No hay muebles."); // Debug log
                 return;
             }

             const { jsPDF } = window.jspdf;
             const doc = new jsPDF('p', 'mm', 'letter');

             // Información de la empresa y cliente (similar al PDF de cotización)
             const empresaNombre = infoEmpresa.nombre;
             const empresaDireccion = infoEmpresa.direccion;
             const empresaTelefono = infoEmpresa.telefono;
             const empresaEmail = infoEmpresa.email;
             const empresaLogoUrl = infoEmpresa.logoUrl;

             const clienteNombre = document.getElementById('cliente-nombre').value.trim();
             const clienteTelefono = document.getElementById('cliente-telefono').value.trim();
             const clienteDireccion = document.getElementById('cliente-direccion').value.trim();

             const fechaCreacion = formatDate(new Date());


             // --- Encabezado del PDF de Materiales ---

             // Agregar Logo si hay URL
             if (empresaLogoUrl) {
                 try {
                      const img = new Image();
                      img.onload = function() {
                          doc.addImage(img, 'PNG', 15, 10, 40, 40);
                          addPdfMaterialsContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacion);
                          // Guardar el archivo PDF dentro del onload para asegurar que la imagen esté incluida
                          doc.save('matriz-produccion.pdf'); // Nombre del archivo actualizado
                          console.log("PDF de matriz de producción generado con logo."); // Debug log
                      };
                      img.onerror = function() {
                          console.error("Error al cargar la imagen del logo para lista de materiales. Generando sin logo.");
                          addPdfMaterialsContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacion);
                          doc.save('matriz-produccion.pdf'); // Nombre del archivo actualizado
                          console.warn("PDF de matriz de producción generado sin logo debido a error de carga."); // Debug log
                      };
                      img.crossOrigin = '';
                      img.src = empresaLogoUrl;

                 } catch (e) {
                     console.error("Error al intentar añadir la imagen del logo para lista de materiales:", e);
                     addPdfMaterialsContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacion);
                     doc.save('matriz-produccion.pdf'); // Nombre del archivo actualizado
                     console.error("PDF de matriz de producción generado sin logo debido a error en try-catch."); // Debug log
                 }

             } else {
                  addPdfMaterialsContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacion);
                  doc.save('matriz-produccion.pdf'); // Nombre del archivo actualizado
                  console.log("PDF de matriz de producción generado sin logo (no URL proporcionada)."); // Debug log
             }
        }

        // Función auxiliar para añadir el contenido del PDF de lista de materiales
        function addPdfMaterialsContent(doc, empresaNombre, empresaDireccion, empresaTelefono, empresaEmail, clienteNombre, clienteTelefono, clienteDireccion, fechaCreacionFormatted) {
            console.log("Añadiendo contenido al PDF de matriz de producción..."); // Debug log
            // Información de la empresa
            doc.setFontSize(10);
             let empresaTextY = 10;
             if (infoEmpresa.logoUrl) {
                 empresaTextY = 55;
             }
            doc.text(empresaNombre, 15, empresaTextY);
            doc.text(empresaDireccion, 15, empresaTextY + 5);
            doc.text(`Teléfono: ${empresaTelefono}`, 15, empresaTextY + 10);
            doc.text(`Email: ${empresaEmail}`, 15, empresaTextY + 15);

            doc.setFontSize(20);
            // Título actualizado a "MATRIZ DE PRODUCCION"
            doc.text('MATRIZ DE PRODUCCION', doc.internal.pageSize.getWidth() - 15, 15, { align: 'right' });

            doc.setFontSize(10);
            doc.text(`FECHA: ${fechaCreacionFormatted}`, doc.internal.pageSize.getWidth() - 15, 25, { align: 'right' });


            // Información del cliente
            let currentY = Math.max(empresaTextY + 25, 45);
            doc.setFontSize(12);
            doc.text('Información del Cliente:', 15, currentY);
            currentY += 7;
            if (clienteNombre) {
                doc.text(`Nombre: ${clienteNombre}`, 15, currentY);
                currentY += 7;
            }
             if (clienteTelefono) {
                doc.text(`Teléfono: ${clienteTelefono}`, 15, currentY);
                currentY += 7;
            }
             if (clienteDireccion) {
                doc.text(`Dirección: ${clienteDireccion}`, 15, currentY);
                currentY += 7;
            }
             if (clienteNombre || clienteTelefono || clienteDireccion) {
                 currentY += 5;
             }

            currentY += 10; // Espacio antes de empezar la lista de muebles

            // Iterar sobre cada mueble para listar sus materiales
            muebles.forEach((mueble, index) => {
                // Título del mueble en el PDF
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(`${mueble.nombre} (x${mueble.cantidad})`, 15, currentY);
                currentY += 8; // Espacio después del nombre del mueble

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");

                // Preparar datos para la tabla de materiales de este mueble
                const materialTableData = [];
                let totalCostoMaterialesMueble = 0; // Variable para sumar el costo de materiales de este mueble


                // Agregar tableros
                if (mueble.tableros.length > 0) {
                    // materialTableData.push(['', 'Tableros:', '', '', '']); // Fila de encabezado para sección (opcional en PDF)
                    for (const tablero of mueble.tableros) {
                        let nombreMaterial, precioUnitario, cantidadTotal, subtotal;
                        if (tablero.tipo && materiales.tableros[tablero.tipo]) {
                            nombreMaterial = materiales.tableros[tablero.tipo].nombre;
                            precioUnitario = materiales.tableros[tablero.tipo].precio;
                            cantidadTotal = tablero.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                            subtotal = cantidadTotal * precioUnitario;
                             materialTableData.push([
                                 nombreMaterial,
                                 `${cantidadTotal} unidad(es)`,
                                 `$${precioUnitario.toFixed(2)}`,
                                 `$${subtotal.toFixed(2)}`
                             ]);
                             totalCostoMaterialesMueble += subtotal; // Sumar al total
                        } else if (tablero.nombre && tablero.precio !== undefined) { // Material personalizado
                            nombreMaterial = `${tablero.nombre} (Personalizado)`;
                            precioUnitario = tablero.precio;
                            cantidadTotal = tablero.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                            subtotal = cantidadTotal * precioUnitario;
                            materialTableData.push([
                                nombreMaterial,
                                `${cantidadTotal} unidad(es)`,
                                `$${precioUnitario.toFixed(2)}`,
                                `$${subtotal.toFixed(2)}`
                            ]);
                            totalCostoMaterialesMueble += subtotal; // Sumar al total
                        }
                    }
                }

                // Agregar cantos
                if (mueble.cantos.length > 0) {
                    if (materialTableData.length > 0) materialTableData.push(['', '', '', '']); // Espacio si hay secciones anteriores
                    // materialTableData.push(['', 'Cantos (ML):', '', '', '']); // Fila de encabezado para sección (opcional en PDF)
                     for (const canto of mueble.cantos) {
                         let nombreMaterial, precioUnitario, cantidadTotal, subtotal;
                         if (canto.tipo && materiales.cantos[canto.tipo]) {
                             nombreMaterial = materiales.cantos[canto.tipo].nombre;
                             precioUnitario = materiales.cantos[canto.tipo].precio;
                             cantidadTotal = canto.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                             subtotal = cantidadTotal * precioUnitario;
                             materialTableData.push([
                                 nombreMaterial,
                                 `${cantidadTotal.toFixed(2)} ML`,
                                 `$${precioUnitario.toFixed(2)}`,
                                 `$${subtotal.toFixed(2)}`
                             ]);
                             totalCostoMaterialesMueble += subtotal; // Sumar al total
                         } else if (canto.nombre && canto.precio !== undefined) { // Material personalizado
                             nombreMaterial = `${canto.nombre} (Personalizado)`;
                             precioUnitario = canto.precio;
                             cantidadTotal = canto.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                             subtotal = cantidadTotal * precioUnitario;
                             materialTableData.push([
                                 nombreMaterial,
                                 `${cantidadTotal.toFixed(2)} ML`,
                                 `$${precioUnitario.toFixed(2)}`,
                                 `$${subtotal.toFixed(2)}`
                             ]);
                             totalCostoMaterialesMueble += subtotal; // Sumar al total
                         }
                     }
                }

                // Agregar herrajes por categoría
                const herrajesAgrupados = {};
                mueble.herrajes.forEach(herraje => {
                    // Usar el nombre o tipo para agrupar, prefiriendo el nombre si es personalizado
                    const categoriaKey = herraje.categoria || 'otros'; // Usar 'otros' si no hay categoría definida (para personalizados sin categoría)
                    if (!herrajesAgrupados[categoriaKey]) {
                        herrajesAgrupados[categoriaKey] = [];
                    }
                    herrajesAgrupados[categoriaKey].push(herraje);
                });

                const herrajeCategorias = Object.keys(herrajesAgrupados);
                 if (herrajeCategorias.length > 0) {
                     if (materialTableData.length > 0) materialTableData.push(['', '', '', '']); // Espacio si hay secciones anteriores
                     // materialTableData.push(['', 'Herrajes:', '', '', '']); // Fila de encabezado para sección (opcional en PDF)

                     herrajeCategorias.forEach(categoria => {
                         const itemsCategoria = herrajesAgrupados[categoria];
                         if (itemsCategoria.length > 0) {
                             // materialTableData.push([`  - ${categoria.charAt(0).toUpperCase() + categoria.slice(1)}:`, '', '', '']); // Indentar subtítulo (opcional en PDF)
                              itemsCategoria.forEach(herraje => {
                                  let nombreMaterial, precioUnitario, cantidadTotal, subtotal;
                                  if (herraje.tipo && materiales.herrajes[categoria] && materiales.herrajes[categoria][herraje.tipo]) {
                                      nombreMaterial = materiales.herrajes[categoria][herraje.tipo].nombre;
                                      precioUnitario = materiales.herrajes[categoria][herraje.tipo].precio;
                                       cantidadTotal = herraje.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                                      subtotal = cantidadTotal * precioUnitario;
                                      materialTableData.push([
                                          nombreMaterial, // Nombre del herraje
                                          `${cantidadTotal} unidad(es)`,
                                          `$${precioUnitario.toFixed(2)}`,
                                          `$${subtotal.toFixed(2)}`
                                      ]);
                                      totalCostoMaterialesMueble += subtotal; // Sumar al total
                                  } else if (herraje.nombre && herraje.precio !== undefined) { // Material personalizado
                                      nombreMaterial = `${herraje.nombre} (Personalizado)`;
                                      precioUnitario = herraje.precio;
                                       cantidadTotal = herraje.cantidad * mueble.cantidad; // Multiplicar por la cantidad de muebles
                                      subtotal = cantidadTotal * precioUnitario;
                                      materialTableData.push([
                                          nombreMaterial, // Nombre del herraje
                                          `${cantidadTotal} unidad(es)`,
                                          `$${precioUnitario.toFixed(2)}`,
                                          `$${subtotal.toFixed(2)}`
                                      ]);
                                      totalCostoMaterialesMueble += subtotal; // Sumar al total
                                  }
                              });
                         }
                     });
                 }


                // Generar la tabla de materiales para este mueble
                if (materialTableData.length > 0) {
                    doc.autoTable({
                        startY: currentY,
                        head: [['MATERIAL', 'CANTIDAD', 'PRECIO UNITARIO', 'SUBTOTAL']], // Encabezados de la tabla de materiales
                        body: materialTableData,
                        columnStyles: {
                            0: { cellWidth: 70, halign: 'left' }, // Nombre del material (ajustado para más espacio)
                            1: { cellWidth: 30, halign: 'center' }, // Cantidad
                            2: { cellWidth: 30, halign: 'right' }, // Precio Unitario
                            3: { cellWidth: 30, halign: 'right' } // Subtotal
                        },
                         headStyles: {
                             fillColor: [155, 89, 182], // Morado
                             textColor: [255, 255, 255],
                             halign: 'center'
                         },
                         styles: {
                             lineWidth: 0.1,
                             lineColor: [0, 0, 0],
                             cellPadding: 2
                         },
                         bodyStyles: {
                              lineWidth: 0.1,
                              lineColor: [0, 0, 0]
                         },
                        margin: { left: 15, right: 15 },
                        didDrawPage: function (data) {
                            // Opcional: añadir pie de página o encabezado en cada página
                        }
                    });
                    // Actualizar Y después de la tabla de materiales
                    currentY = doc.lastAutoTable.finalY;

                    // Añadir el total de costo de materiales para este mueble
                    const totalMaterialesData = [
                        [{content: 'COSTO TOTAL DE MATERIALES DEL MUEBLE', colSpan: 3, styles: {fontStyle: 'bold', halign: 'right'}}, `$${totalCostoMaterialesMueble.toFixed(2)}`]
                    ];
                     doc.autoTable({
                         startY: currentY,
                         body: totalMaterialesData,
                         theme: 'plain',
                         styles: { cellPadding: 2 },
                         columnStyles: { 0: { cellWidth: 70 + 30 + 30, halign: 'right', fontStyle: 'bold' }, 1: { cellWidth: 30, halign: 'right' } },
                         margin: { left: 15 },
                     });
                     currentY = doc.lastAutoTable.finalY;

                    // Añadir el total de transporte e instalación para este mueble
                     const totalTransporteInstalacionMueble = (mueble.transporte || 0) * mueble.cantidad + (mueble.instalacion || 0) * mueble.cantidad; // Multiplicar por cantidad de muebles
                     const totalAdicionalesData = [
                         [{content: 'COSTO TOTAL TRANSPORTE E INSTALACIÓN DEL MUEBLE', colSpan: 3, styles: {fontStyle: 'bold', halign: 'right'}}, `$${totalTransporteInstalacionMueble.toFixed(2)}`]
                     ];
                      doc.autoTable({
                          startY: currentY,
                          body: totalAdicionalesData,
                          theme: 'plain',
                          styles: { cellPadding: 2 },
                          columnStyles: { 0: { cellWidth: 70 + 30 + 30, halign: 'right', fontStyle: 'bold' }, 1: { cellWidth: 30, halign: 'right' } },
                          margin: { left: 15 },
                      });
                     currentY = doc.lastAutoTable.finalY;

                    // Añadir el costo total de producción (materiales + adicionales)
                     const costoTotalProduccionMueble = totalCostoMaterialesMueble + totalTransporteInstalacionMueble;
                     const totalProduccionData = [
                         [{content: 'COSTO TOTAL DE PRODUCCIÓN DEL MUEBLE', colSpan: 3, styles: {fontStyle: 'bold', halign: 'right'}}, `$${costoTotalProduccionMueble.toFixed(2)}`]
                     ];
                      doc.autoTable({
                          startY: currentY,
                          body: totalProduccionData,
                          theme: 'plain',
                          styles: { cellPadding: 2 },
                          columnStyles: { 0: { cellWidth: 70 + 30 + 30, halign: 'right', fontStyle: 'bold' }, 1: { cellWidth: 30, halign: 'right' } },
                          margin: { left: 15 },
                      });
                     currentY = doc.lastAutoTable.finalY + 10; // Espacio después del total del mueble

                } else {
                     currentY += 10; // Si no hay materiales, solo añadir espacio
                }

            });

             // Opcional: Añadir un pie de página o resumen general en el PDF de materiales si es necesario
             console.log("Contenido añadido al PDF de matriz de producción."); // Debug log
        }


        // Función para formatear una fecha como DD/MM/YYYY
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // getMonth() es base 0
            const year = date.getFullYear();
            return `${year}-${month}-${day}`; // Cambiado a YYYY-MM-DD para consistencia
        }


        // ======================================================================
        // Event Listeners Principales
        // ======================================================================

        document.addEventListener('DOMContentLoaded', async function() { // Usar async aquí
            console.log("DOMContentLoaded event fired. Initializing app..."); // Debug log
            // --- Inicialización de la aplicación al cargar la página ---
            try {
                await openDatabase(); // Abrir/crear la base de datos IndexedDB
                await cargarPrecios(); // Cargar precios desde IndexedDB
                await cargarCotizacionesGuardadas(); // Cargar cotizaciones guardadas desde IndexedDB
                console.log("IndexedDB initialization and data loading complete."); // Debug log
            } catch (e) {
                console.error("Error durante la inicialización de la base de datos:", e);
                alert("Error al inicializar la base de datos local. Algunas funciones pueden no estar disponibles.");
            }


            // Agregar un item por defecto a cada sección dinámica del mueble actual al cargar
            console.log("Adding initial dynamic items to current mueble section..."); // Debug log
            agregarTableroItem();
            agregarCantoItem();
            agregarHerrajeItem('correderas');
            agregarHerrajeItem('bisagras');
            agregarHerrajeItem('tiradores');
            agregarHerrajeItem('otros');
            console.log("Initial dynamic items added to current mueble section."); // Debug log


            // Mostrar la lista inicial de muebles (vacía o con datos si se cargaran)
            // Call this after all elements are definitely in the DOM
            // Moved this call to the end of the DOMContentLoaded listener
            // actualizarListaMuebles();


            // --- Event Listeners para los botones ---
            console.log("Attaching button event listeners..."); // Debug log

            // Event listener para el botón "Agregar Mueble"
            const btnAgregar = document.getElementById('btn-agregar');
            if (btnAgregar) {
                 btnAgregar.addEventListener('click', function() {
                    console.log("Button 'Agregar Mueble' clicked."); // Debug log
                    const nombre = document.getElementById('nombre').value.trim(); // Usar trim() para eliminar espacios en blanco
                     const cantidadMueble = parseInt(document.getElementById('cantidad-mueble').value) || 1; // Obtener cantidad de muebles
                     const transporte = parseFloat(document.getElementById('costo-transporte').value) || 0; // Obtener costo de transporte
                     const instalacion = parseFloat(document.getElementById('costo-instalacion').value) || 0; // Obtener costo de instalación


                    // Validar que se haya ingresado un nombre y una cantidad válida
                    if (!nombre) {
                        alert('Por favor ingresa un nombre para el mueble');
                        console.log("Validation failed: Nombre vacío."); // Debug log
                        return;
                    }
                     if (cantidadMueble <= 0) {
                         alert('La cantidad de muebles debe ser al menos 1');
                         console.log("Validation failed: Cantidad <= 0."); // Debug log
                         return;
                     }


                    // Obtener cantidades de tableros seleccionados de los items dinámicos (incluyendo personalizados)
                    const tableros = [];
                    const tablerosContainerItems = document.getElementById('current-mueble-tableros-container'); // Usar el nuevo ID
                     if (tablerosContainerItems) {
                         tablerosContainerItems.querySelectorAll('.herraje-item').forEach(item => {
                             const select = item.querySelector('select');
                             const cantidadInput = item.querySelector('input[type="number"]');
                             const customInputsDiv = item.querySelector('.custom-material-inputs');

                             if (select && cantidadInput && customInputsDiv) {
                                 const selectedValue = select.value;

                                 if (selectedValue === 'custom') {
                                     const customNombre = customInputsDiv.querySelector('.custom-nombre').value.trim();
                                     const customPrecio = parseFloat(customInputsDiv.querySelector('.custom-precio').value) || 0;
                                     const customCantidad = parseFloat(customInputsDiv.querySelector('.custom-cantidad').value) || 0;

                                     if (customNombre && customPrecio > 0 && customCantidad > 0) {
                                         tableros.push({
                                             nombre: customNombre,
                                             precio: customPrecio,
                                             cantidad: customCantidad
                                         });
                                     } else if (customNombre || customPrecio > 0 || customCantidad > 0) {
                                         console.warn(`Datos incompletos para tablero personalizado.`);
                                     }

                                 } else if (selectedValue && materiales.tableros[selectedValue]) {
                                      const cantidad = parseFloat(cantidadInput.value) || 0;
                                      if (cantidad > 0) {
                                          tableros.push({
                                              tipo: selectedValue, // Guardar el ID para referencia a la base de datos
                                              cantidad: cantidad
                                          });
                                      }
                                 } else if (selectedValue && !materiales.tableros[selectedValue]) {
                                     console.warn(`Tablero predefinido no válido seleccionado. ID: ${selectedValue}`);
                                 }
                             }
                         });
                     }
                     console.log("Tableros capturados:", tableros); // Debug log


                     // Obtener cantos seleccionados y sus cantidades de los items dinámicos (incluyendo personalizados)
                     const cantos = [];
                     const cantosContainerItems = document.getElementById('current-mueble-cantos-container'); // Usar el nuevo ID
                     if (cantosContainerItems) {
                         cantosContainerItems.querySelectorAll('.herraje-item').forEach(item => {
                             const select = item.querySelector('select');
                             const cantidadInput = item.querySelector('input[type="number"]');
                             const customInputsDiv = item.querySelector('.custom-material-inputs');

                             if (select && cantidadInput && customInputsDiv) {
                                 const selectedValue = select.value;

                                 if (selectedValue === 'custom') {
                                     const customNombre = customInputsDiv.querySelector('.custom-nombre').value.trim();
                                     const customPrecio = parseFloat(customInputsDiv.querySelector('.custom-precio').value) || 0;
                                     const customCantidad = parseFloat(customInputsDiv.querySelector('.custom-cantidad').value) || 0;

                                     if (customNombre && customPrecio > 0 && customCantidad > 0) {
                                         cantos.push({
                                             nombre: customNombre,
                                             precio: customPrecio,
                                             cantidad: customCantidad
                                         });
                                     } else if (customNombre || customPrecio > 0 || customCantidad > 0) {
                                         console.warn(`Datos incompletos para canto personalizado.`);
                                     }

                                 } else if (selectedValue && materiales.cantos[selectedValue]) {
                                      const cantidad = parseFloat(cantidadInput.value) || 0;
                                      if (cantidad > 0) {
                                          cantos.push({
                                              tipo: selectedValue, // Guardar el ID para referencia a la base de datos
                                              cantidad: cantidad
                                          });
                                      }
                                 } else if (selectedValue && !materiales.cantos[selectedValue]) {
                                     console.warn(`Canto predefinido no válido seleccionado. ID: ${selectedValue}`);
                                 }
                             }
                         });
                     }
                     console.log("Cantos capturados:", cantos); // Debug log


                    // Obtener herrajes seleccionados y sus cantidades de los items dinámicos (incluyendo personalizados)
                    const herrajes = [];

                    // Recorrer cada categoría de herrajes (Correderas, Bisagras, Tiradores, Otros)
                    document.querySelectorAll('.current-mueble-section .herraje-categoria').forEach(categoriaDiv => { // Buscar dentro de la sección del mueble actual
                        const container = categoriaDiv.querySelector('.dynamic-items-container'); // Buscar el contenedor dinámico dentro de la categoría
                        if (container) {
                            // Extraer la categoría del ID del contenedor (ej: 'current-mueble-correderas-container' -> 'correderas')
                            const categoria = container.id.replace('current-mueble-', '').replace('-container', '');

                            container.querySelectorAll('.herraje-item').forEach(item => {
                                const select = item.querySelector('select');
                                const cantidadInput = item.querySelector('input[type="number"]');
                                const customInputsDiv = item.querySelector('.custom-material-inputs');


                                if (select && cantidadInput && customInputsDiv) {
                                    const selectedValue = select.value;

                                    if (selectedValue === 'custom') {
                                         const customNombre = customInputsDiv.querySelector('.custom-nombre').value.trim();
                                         const customPrecio = parseFloat(customInputsDiv.querySelector('.custom-precio').value) || 0;
                                         const customCantidad = parseFloat(customInputsDiv.querySelector('.custom-cantidad').value) || 0;

                                         if (customNombre && customPrecio > 0 && customCantidad > 0) {
                                             herrajes.push({
                                                 // No hay categoría para herrajes personalizados en este modelo simple
                                                 nombre: customNombre,
                                                 precio: customPrecio,
                                                 cantidad: customCantidad
                                             });
                                         } else if (customNombre || customPrecio > 0 || customCantidad > 0) {
                                             console.warn(`Datos incompletos para herraje personalizado.`);
                                         }

                                    } else if (selectedValue && materiales.herrajes[categoria] && materiales.herrajes[categoria][selectedValue]) {
                                        const cantidad = parseFloat(cantidadInput.value) || 0;
                                        if (cantidad > 0) {
                                             herrajes.push({
                                                categoria: categoria, // Guardar la categoría
                                                tipo: selectedValue, // Guardar el ID para referencia a la base de datos
                                                cantidad: cantidad
                                            });
                                        }
                                    } else if (selectedValue && (!materiales.herrajes[categoria] || !materiales.herrajes[categoria][selectedValue])) {
                                        console.warn(`Herraje predefinido no válido seleccionado en la categoría "${categoria}". ID: ${selectedValue}`);
                                    }
                                }
                            });
                        }
                    });
                    console.log("Herrajes capturados:", herrajes); // Debug log


                    // Verificar que al menos haya algún material, canto, herraje o costo adicional seleccionado/ingresado
                    if (tableros.length === 0 && cantos.length === 0 && herrajes.length === 0 && transporte === 0 && instalacion === 0) {
                        alert('Debes ingresar al menos un material, canto, herraje o costo adicional para agregar el mueble');
                        console.log("Validation failed: No materials or additional costs."); // Debug log
                        return;
                    }

                    // Crear el nuevo objeto mueble
                    const nuevoMueble = {
                        nombre,
                        cantidad: cantidadMueble, // Guardar la cantidad del mueble
                        tableros,
                        cantos, // Guardar los cantos
                        herrajes,
                        transporte, // Guardar costo de transporte
                        instalacion // Guardar costo de instalación
                    };

                    // Añadir el nuevo mueble al array
                    muebles.push(nuevoMueble);
                    console.log("Muebles array after adding:", muebles); // Log the entire muebles array
                    // Actualizar la lista mostrada en la interfaz
                    actualizarListaMuebles();

                    // --- Limpiar el formulario después de agregar ---
                    document.getElementById('nombre').value = ''; // Limpiar nombre
                     document.getElementById('cantidad-mueble').value = '1'; // Resetear cantidad a 1
                     document.getElementById('costo-transporte').value = '0'; // Limpiar transporte
                     document.getElementById('costo-instalacion').value = '0'; // Limpiar instalación

                    // Limpiar items dinámicos (tableros, cantos y herrajes) y agregar uno por defecto de cada tipo
                     document.querySelectorAll('.current-mueble-section .dynamic-items-container').forEach(container => { // Limpiar solo los contenedores del mueble actual
                         container.innerHTML = ''; // Limpiar completamente el contenedor
                     });

                    console.log("Adding initial items after adding mueble..."); // Log before adding initial items
                    // Agregar uno de cada tipo por defecto nuevamente después de limpiar
                    agregarTableroItem(); // Agregar un tablero por defecto
                    agregarCantoItem(); // Agregar un canto por defecto
                    agregarHerrajeItem('correderas');
                    agregarHerrajeItem('bisagras');
                    agregarHerrajeItem('tiradores');
                    agregarHerrajeItem('otros'); // Aseguramos que se agrega uno de "otros"
                     console.log("Finished adding initial dynamic items after adding mueble."); // Log after adding initial items


                    document.getElementById('nombre').focus(); // Poner el foco en el campo de nombre
                    console.log("Mueble agregado y formulario limpiado."); // Debug log
                });
                 console.log("Event listener attached to #btn-agregar."); // Debug log
            } else {
                 console.error("Button #btn-agregar not found."); // Debug log
            }


            // Event listener para el botón "Generar PDF" (para el cliente)
            const btnGenerarPdf = document.getElementById('btn-generar-pdf');
            if (btnGenerarPdf) {
                 btnGenerarPdf.addEventListener('click', generarPDF);
                 console.log("Event listener attached to #btn-generar-pdf."); // Debug log
            } else {
                 console.error("Button #btn-generar-pdf not found."); // Debug log
            }


            // Event listener para el botón "Actualizar Precios"
            const btnActualizarPrecios = document.getElementById('btn-actualizar-precios');
            if (btnActualizarPrecios) {
                 btnActualizarPrecios.addEventListener('click', mostrarFormularioPrecios);
                 console.log("Event listener attached to #btn-actualizar-precios."); // Debug log
            } else {
                 console.error("Button #btn-actualizar-precios not found."); // Debug log
            }


            // Event listener para el botón "Generar Lista de Materiales" (en la interfaz)
            const btnGenerarListaMateriales = document.getElementById('btn-generar-lista-materiales');
            if (btnGenerarListaMateriales) {
                 btnGenerarListaMateriales.addEventListener('click', generarListaMateriales);
                 console.log("Event listener attached to #btn-generar-lista-materiales."); // Debug log
            } else {
                 console.error("Button #btn-generar-lista-materiales not found."); // Debug log
            }


            // Event listener para el botón "Exportar Lista Materiales (PDF)"
            const btnExportarListaMaterialesPdf = document.getElementById('btn-exportar-lista-materiales-pdf');
            if (btnExportarListaMaterialesPdf) {
                 btnExportarListaMaterialesPdf.addEventListener('click', generarPDFListaMateriales);
                 console.log("Event listener attached to #btn-exportar-lista-materiales-pdf."); // Debug log
            } else {
                 console.error("Button #btn-exportar-lista-materiales-pdf not found."); // Debug log
            }


            // Event listener para el nuevo botón "Guardar Cotización Actual"
            const btnGuardarCotizacion = document.getElementById('btn-guardar-cotizacion');
            if (btnGuardarCotizacion) {
                 btnGuardarCotizacion.addEventListener('click', guardarCotizacionActual);
                 console.log("Event listener attached to #btn-guardar-cotizacion."); // Debug log
            } else {
                 console.error("Button #btn-guardar-cotizacion not found."); // Debug log
            }


             // Event listener para el nuevo botón "Exportar Cotizaciones"
            const btnExportarCotizaciones = document.getElementById('btn-exportar-cotizaciones');
            if (btnExportarCotizaciones) {
                 btnExportarCotizaciones.addEventListener('click', exportarCotizaciones);
                 console.log("Event listener attached to #btn-exportar-cotizaciones."); // Debug log
            } else {
                 console.error("Button #btn-exportar-cotizaciones not found."); // Debug log
            }


             // Event listener para el input de archivo de "Importar Cotizaciones"
            const inputImportarCotizaciones = document.getElementById('input-importar-cotizaciones');
            if (inputImportarCotizaciones) {
                 inputImportarCotizaciones.addEventListener('change', importarCotizaciones);
                 console.log("Event listener attached to #input-importar-cotizaciones."); // Debug log
             } else {
                 console.error("Input #input-importar-cotizaciones not found."); // Debug log
             }


            // Event listener para actualizar la lista cuando cambia el porcentaje de ganancia
            const inputGanancia = document.getElementById('ganancia');
            if (inputGanancia) {
                 inputGanancia.addEventListener('change', actualizarListaMuebles);
                 console.log("Event listener attached to #ganancia."); // Debug log
            } else {
                 console.error("Input #ganancia not found."); // Debug log
            }

             // Event listener para actualizar la lista cuando cambia el porcentaje de descuento
             const inputDescuento = document.getElementById('descuento');
             if (inputDescuento) {
                 inputDescuento.addEventListener('change', actualizarListaMuebles);
                 console.log("Event listener attached to #descuento."); // Debug log
             } else {
                  console.error("Input #descuento not found."); // Debug log
             }

            // Call actualizarListaMuebles here, after all static elements are in the DOM
            actualizarListaMuebles();
             console.log("All main button event listeners attached."); // Debug log
        });


    </script>
</head>
<body class="bg-gray-100 p-5">
    <div class="container mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Cotizador de Muebles de Melamina</h1>

        <div class="form-section border border-gray-200 p-6 rounded-lg bg-gray-50 mb-8">
             <h2 class="text-2xl font-bold text-gray-800 mb-4">Información General</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                    <label for="cliente-nombre" class="block text-gray-700 font-bold mb-2">Nombre del Cliente</label>
                    <input type="text" id="cliente-nombre" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="form-group">
                    <label for="cliente-telefono" class="block text-gray-700 font-bold mb-2">Teléfono del Cliente</label>
                    <input type="text" id="cliente-telefono" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="form-group md:col-span-2"> <label for="cliente-direccion" class="block text-gray-700 font-bold mb-2">Dirección del Cliente</label>
                    <input type="text" id="cliente-direccion" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                 <div class="form-group">
                     <label for="costo-transporte" class="block text-gray-700 font-bold mb-2">Costo de Transporte por Mueble</label>
                     <input type="number" id="costo-transporte" min="0" step="0.01" value="0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
                  <div class="form-group">
                     <label for="costo-instalacion" class="block text-gray-700 font-bold mb-2">Costo de Instalación por Mueble</label>
                     <input type="number" id="costo-instalacion" min="0" step="0.01" value="0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
             </div>
        </div>


        <div class="current-mueble-section mb-8">
             <h2 class="text-2xl font-bold text-blue-700 mb-4 border-b-2 border-blue-500 pb-2">Configurar Mueble Actual</h2>
             <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                 <div class="form-group col-span-3">
                    <label for="nombre" class="block text-gray-700 font-bold mb-2">Nombre del Mueble</label>
                    <input type="text" id="nombre" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                 <div class="form-group col-span-1">
                    <label for="cantidad-mueble" class="block text-gray-700 font-bold mb-2">Cantidad</label>
                    <input type="number" id="cantidad-mueble" min="1" step="1" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="form-group">
                    <h3 class="text-xl font-bold text-blue-600 mb-4 border-b border-blue-400 pb-2">Tableros de Melamina</h3>
                    <div id="current-mueble-tableros-container" class="dynamic-items-container p-4 border border-gray-200 rounded-md bg-white">
                        </div>
                    <button type="button" class="btn-primary btn-material bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4" onclick="agregarTableroItem()">+ Agregar Tablero</button>
                </div>

                 <div class="form-group">
                    <h3 class="text-xl font-bold text-blue-600 mb-4 border-b border-blue-400 pb-2">Cantos (ML)</h3>
                    <div id="current-mueble-cantos-container" class="dynamic-items-container p-4 border border-gray-200 rounded-md bg-white">
                         </div>
                    <button type="button" class="btn-primary btn-material bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4" onclick="agregarCantoItem()">+ Agregar Canto</button>
                </div>

                <div class="form-group md:col-span-2">
                    <h3 class="text-xl font-bold text-blue-600 mb-4 border-b border-blue-400 pb-2">Herrajes</h3>
                    <div class="herraje-categoria border border-gray-200 p-4 rounded-md bg-white mb-6">
                        <h4 class="text-lg font-semibold text-blue-600 mb-3">Correderas</h4>
                        <div id="current-mueble-correderas-container" class="dynamic-items-container">
                             </div>
                        <button type="button" class="btn-primary btn-material bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-3" onclick="agregarHerrajeItem('correderas')">+ Agregar Corredera</button>
                    </div>

                    <div class="herraje-categoria border border-gray-200 p-4 rounded-md bg-white mb-6">
                        <h4 class="text-lg font-semibold text-blue-600 mb-3">Bisagras</h4>
                        <div id="current-mueble-bisagras-container" class="dynamic-items-container">
                             </div>
                        <button type="button" class="btn-primary btn-material bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-3" onclick="agregarHerrajeItem('bisagras')">+ Agregar Bisagra</button>
                    </div>

                    <div class="herraje-categoria border border-gray-200 p-4 rounded-md bg-white mb-6">
                        <h4 class="text-lg font-semibold text-blue-600 mb-3">Tiradores</h4>
                        <div id="current-mueble-tiradores-container" class="dynamic-items-container">
                             </div>
                        <button type="button" class="btn-primary btn-material bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-3" onclick="agregarHerrajeItem('tiradores')">+ Agregar Tirador</button>
                    </div>

                    <div class="herraje-categoria border border-gray-200 p-4 rounded-md bg-white mb-6">
                        <h4 class="text-lg font-semibold text-blue-600 mb-3">Otros Herrajes</h4>
                        <div id="current-mueble-otros-container" class="dynamic-items-container">
                             </div>
                        <button type="button" class="btn-primary btn-material bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-3" onclick="agregarHerrajeItem('otros')">+ Agregar Otro</button>
                    </div>
                </div>
            </div>

             <button id="btn-agregar" class="btn-primary btn-material bg-blue-600 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg mt-8 text-lg">Agregar Mueble a Cotización</button>
        </div>


        <div class="muebles-list mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Muebles Cotizados</h2>
            <div id="lista-muebles"></div>

            <div class="total-section bg-green-100 p-6 rounded-lg text-right mt-8 shadow-md">
                <h3 class="text-xl font-bold text-green-800 mb-2">Total de la Cotización</h3>
                <p id="total-cotizacion" class="text-2xl font-extrabold text-green-900">$0.00</p>
            </div>

            <div class="mt-8 flex flex-wrap gap-4">
                 <div class="form-group w-full md:w-auto flex-grow">
                     <label for="ganancia" class="block text-gray-700 font-bold mb-2">Porcentaje de Ganancia (%)</label>
                     <input type="number" id="ganancia" min="0" step="1" value="30" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
                  <div class="form-group w-full md:w-auto flex-grow">
                     <label for="descuento" class="block text-gray-700 font-bold mb-2">Descuento (%)</label>
                     <input type="number" id="descuento" min="0" step="1" value="0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
            </div>

            <div class="mt-8 flex flex-wrap gap-4">
                <button id="btn-generar-pdf" class="btn-pdf btn-material bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Generar PDF Cotización</button>
                <button id="btn-actualizar-precios" class="btn-update btn-material bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Actualizar Precios Base</button>
                <button id="btn-generar-lista-materiales" class="btn-materials-list btn-material bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Ver Lista Materiales por Mueble</button>
                <button id="btn-exportar-lista-materiales-pdf" class="btn-materials-list btn-material bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded">Exportar Matriz Producción (PDF)</button>
                <button id="btn-guardar-cotizacion" class="btn-primary btn-material bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Guardar Cotización Actual</button>
            </div>
        </div>

        <div id="materials-list-section" class="materials-list-section mt-8 pt-6 border-t border-gray-200" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Materiales por Mueble</h2>
            <div id="materiales-produccion-lista"></div>
        </div>


        <div class="saved-quotes-list-section mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cotizaciones Guardadas</h2>
            <ul id="lista-cotizaciones-guardadas">
                </ul>
             <div class="mt-4 flex flex-wrap gap-4">
                <button id="btn-exportar-cotizaciones" class="btn-secondary btn-material bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Exportar Cotizaciones</button>
                <label for="input-importar-cotizaciones" class="btn-secondary btn-material bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded cursor-pointer">Importar Cotizaciones</label>
                <input type="file" id="input-importar-cotizaciones" accept=".json" class="hidden">
             </div>
        </div>

    </div>
</body>
</html>
